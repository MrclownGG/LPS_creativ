# 开发日志 / 进度记录

本文件用于记录项目开发的重要节点，方便：

- 新开会话时快速了解“已经做到哪一步了”；  
- 回溯某个功能是哪一天、在哪些文件中实现的。

时间以本地时间为准，精确到天即可。

---

## 2025-11-21：后端基础骨架 + 数据库结构 + 视频列表接口

### 1）后端基础骨架（FastAPI）

- 目录：`LPS_creativ/LPS/backend`。  
- 主要文件：  
  - `app/main.py`  
    - 创建 FastAPI 应用。  
    - 提供基础接口：  
      - `GET /health`：服务健康检查。  
      - `GET /db-check`：数据库连通性检查。  
  - `app/core/config.py`  
    - 使用 `.env` 加载配置（环境、API 版本、`DATABASE_URL` 等）。  
  - `app/db/session.py`  
    - 创建 SQLAlchemy `Engine` 与 `SessionLocal`。  
    - 提供 `get_db()` 作为 FastAPI 依赖。  
    - 提供 `get_db_health()` 做数据库健康检测。

### 2）数据库结构（PostgreSQL + Alembic）

- 使用 PostgreSQL，示例数据库名：`lps_creativ`。  
- 通过 Alembic 初始化迁移：  
  - 配置文件：`backend/alembic.ini`。  
  - 迁移 env：`backend/migrations/env.py`（已接入应用配置与 ORM 模型）。  
  - 首次迁移文件：`backend/migrations/versions/27cb92c5c256_create_core_tables.py`。  
    - 创建 8 张核心表：`video` / `template` / `workflow` / `landing_page` / `ad_image_library` / `workflow_ad_map` / `campaign` / `campaign_workflow_map`。  
- ORM 模型定义：`backend/app/db/models.py`。  
- 表级联删除、状态字段等细节见：`LPS_creativ/LPS/docs/数据库设计说明.md` 与 `LPS_creativ/Test/数据库蓝图文档.md`。

### 3）视频列表接口：`GET /api/videos`

- 路由文件：`backend/app/api/videos.py`。  
- 注册方式：`app.include_router(videos_router, prefix="/api")`。  
- 接口定义：  
  - 路径：`GET /api/videos`。  
  - 查询参数：`category`、`page`、`page_size`。  
  - 返回结构：`{ code, message, data: { total, items } }`。  
- 文档：`LPS_creativ/LPS/docs/接口约定.md` 中的「2.3 查询视频列表」。  
- 已通过插入测试数据 + 浏览器访问 `/api/videos?page=1&page_size=20` 验证。

### 4）CORS 配置

- 问题：前端 dev server（`http://127.0.0.1:5173`）调用后端（`http://127.0.0.1:8000`）时浏览器报跨域。  
- 解决：在 `app/main.py` 中加入 `CORSMiddleware`，允许本地前端来源。  
- 修正后，前端可以正常获取数据。

---

## 2025-11-21：前端框架搭建 + 视频列表页面（只读）

### 1）前端框架（Vite + React + TS + AntD）

- 目录：`LPS_creativ/LPS/frontend`。  
- 使用 Vite `react-ts` 模板初始化。  
- 主要依赖：`antd`、`@tanstack/react-query`、`axios`、`zustand`、`react-router-dom`、`dayjs` 等。  
- 入口文件：  
  - `src/main.tsx`：挂载 React 根组件。  
  - `src/App.tsx`：配置 React Query、AntD 主题等，初期渲染 `<VideoListPage />`。

### 2）视频列表页面 v1（只读）

- 文件：`src/pages/VideoListPage.tsx`。  
- 使用 AntD 组件：`Layout` / `Card` / `Table` / `Input.Search`。  
- 数据获取：  
  - `src/api/client.ts`：Axios 实例（`baseURL = http://127.0.0.1:8000/api`）。  
  - `src/api/videos.ts`：定义类型与 `getVideos(params)` / `useVideos(params)`。  
- 功能：  
  - 列表展示：ID / 标题 / 分类 / 海报 URL / 观看量。  
  - 搜索：前端过滤（标题或分类包含关键字）。

---

## 2025-11-21：视频模块 CRUD（手动导入 / 编辑 / 删除）

### 1）后端：视频新增 / 编辑 / 删除接口

- 文件：`backend/app/api/videos.py`。  
- 新增 / 完善接口：  
  - `POST /api/videos`（手动导入视频）  
    - 请求体：`external_id?`, `title`, `category?`, `poster_url`, `view_count?`。  
    - 响应：`{ code, message, data: VideoItem }`。  
  - `PUT /api/videos/{id}`（编辑视频）  
    - 请求体：同上（主要更新 title/category/poster_url/view_count）。  
    - 响应：`{ code, message, data: VideoItem }`。  
  - `DELETE /api/videos/{id}`（删除视频）  
    - 当前为硬删除：直接从 `video` 表删除记录。  
- 接口说明已同步到：`LPS_creativ/LPS/docs/接口约定.md`。

### 2）前端：视频列表 CRUD

- 在 `VideoListPage` 上增加：  
  - 新建视频对话框（调用 `POST /api/videos`）。  
  - 编辑视频对话框（调用 `PUT /api/videos/{id}`）。  
  - 删除确认弹窗（调用 `DELETE /api/videos/{id}`）。  
- 所有写操作统一使用 React Query 的 Mutation，并在成功后失效 `['videos']` 缓存刷新列表。

---

## 2025-11-24：模板渲染静态 HTML + 落地页预览功能

### 1）生成落地页 HTML 并写入磁盘

- 文件：`LPS_creativ/LPS/backend/app/api/workflows.py`。  
- 在 `POST /api/workflows/{id}/generate` 中：  
  - 根据 `Template.html_file_path` 读取模板 HTML（兼容 `LPS/templates/home/index.html` 等多种写法）。  
  - 将模板中的静态资源路径 `href="./..."` / `src="./..."` 改写为 `/templates/...` 形式的绝对路径，配合 `app/main.py` 中的静态目录挂载：  
    - `/generated` → `backend/generated`。  
    - `/templates` → `LPS_creativ/LPS/templates`。  
  - 在 HTML 中注入选中视频 ID 的 JSON：  
    - `<script id="lps-selected-videos" type="application/json">[101,102,103]</script>`。  
  - 将最终 HTML 写入：`backend/generated/{workflow_id}/{landing_page_id}.html`。  
  - 更新 `LandingPage.generated_page_url = "/generated/{workflow_id}/{landing_page_id}.html"`。  
  - 保持原有业务逻辑：生成成功后将 `workflow.status` 从 `draft` 更新为 `pending_ad`。

### 2）落地页预览接口

- 文件：`LPS_creativ/LPS/backend/app/api/workflows.py`。  
- 新增接口：`POST /api/workflows/preview`。  
  - 请求体：`{ video_ids: number[], template_id: number }`。  
  - 行为：  
    - 按模板的 `max_videos` 校验 `video_ids` 数量。  
    - 复用正式生成时相同的渲染逻辑（静态资源修正 + 注入 JSON）。  
    - 将 HTML 写入：`backend/generated/preview/{template_id}_{uuid}.html`。  
    - 返回 `preview_url = "/generated/preview/{filename}.html"`。  
  - 不创建 `landing_page` 记录，也不修改 `workflow` 状态。

### 3）前端：生成页“预览”按钮 + Modal + iframe 预览

- 文件：`LPS_creativ/LPS/frontend/src/api/workflows.ts`  
  - 新增 `previewWorkflow(payload)` 调用 `POST /api/workflows/preview`。  
- 文件：`LPS_creativ/LPS/frontend/src/pages/WorkflowGeneratePage.tsx`  
  - 在“生成落地页”按钮旁增加“预览”按钮：  
    - 复用本地校验，确保选中的视频数量满足所选模板 `max_videos` 要求。  
    - 当前仅支持对单个模板预览，多选模板时给出警告。  
    - 成功拿到 `preview_url` 后，通过 Modal + `<iframe>` 打开预览页面。  
- 预览 Modal 初始为桌面友好尺寸，后续计划逐步收紧为接近手机比例的视图（设计目标约 430×800）。

---

## 2025-11-25：对接 STCine 热门视频排行榜 + 视频列表增强

### 1）后端：`POST /api/videos/sync` 接入 STCine 排行接口

- 文件：`LPS_creativ/LPS/backend/app/api/videos.py`。  
- 接口：`POST /api/videos/sync`。  
- 新增 query 参数：  
  - `limit: int = 50`：同步条数上限（1–500），对应 STCine 接口 `page_size`。  
  - `start_date: date | None`：排行榜查询开始日期（YYYY-MM-DD）。  
  - `end_date: date | None`：排行榜查询结束日期（YYYY-MM-DD）。  
- 日期规则：  
  - `start_date` / `end_date` 都未传时，默认使用“昨天”的单日范围。  
  - 只传一个时，另一个自动与其相同，视为查询单日排行榜。  
- 外部接口调用：  
  - 通过环境变量 `EXTERNAL_VIDEO_API_URL` 调用 STCine 排行接口：  
    - 示例：`GET {EXTERNAL_VIDEO_API_URL}?start_date=2025-11-23&end_date=2025-11-23&page_no=1&page_size=50`。  
  - 当前版本暂未使用 `EXTERNAL_VIDEO_API_TOKEN`。  
- 字段映射（简要）：  
  - `external_id = "STCine:" + movie_id`（例如 `STCine:45677`）。  
  - `title = ch_name`（优先中文名，缺失时退回 `name`，再退回 `"未命名"`）。  
  - `view_count`：转换为整数，异常时默认为 0。  
  - `category = "stcine_hot"`（当前为固定默认值）。  
  - `poster_url`：新插入时暂写为空字符串 `""`，更新已有记录时不覆盖（保留手动维护的真实封面）。  
  - `metadata_`：合并写入 `source="stcine"`、`movie_id`、`name_pt`（原始 `name`）、`langue`。  
- Upsert 策略：  
  - 按 `external_id` 查询本地记录，存在则更新上述字段（除 `poster_url` 外），计入 `updated_count`。  
  - 不存在则插入新记录，计入 `imported_count`。  
- 接口返回示例：  
  ```json
  {
    "code": 0,
    "message": "ok",
    "data": {
      "imported_count": 12,
      "updated_count": 8,
      "source": "stcine",
      "start_date": "2025-11-23",
      "end_date": "2025-11-23",
      "limit": 50
    }
  }
  ```

### 2）前端：从 STCine 导入 + 获取时间 + 观看量排序

- 文件：`LPS_creativ/LPS/frontend/src/pages/VideoListPage.tsx`。  
- 新增「从 API 导入」按钮：  
  - 点击后弹出配置对话框：  
    - 选择数据来源（当前只有 STCine）。  
    - 选择日期范围（AntD `RangePicker`，默认前一天）。  
    - 设置同步条数 `limit`（默认 50，可调）。  
  - 点击“开始导入”后调用 `POST /api/videos/sync`，成功后提示“新增 X 条，更新 Y 条”，并刷新列表。  
- 列表增强：  
  - 新增「获取时间」列：  
    - 使用后端返回的 `updated_at` 字段，前端用 `dayjs` 格式化为 `YYYY-MM-DD HH:mm`。  
    - 用于判断素材最后一次导入 / 更新时间。  
  - 「观看量」列增加一个小的 “↑↓” 控件：  
    - 点击时在「不排序 → 播放量高→低 → 播放量低→高」三种模式之间循环。  
    - 排序逻辑完全在前端基于 `view_count` 实现，不改变接口契约。

### 3）文档更新（与 STCine 同步相关）

- `LPS_creativ/Test/数据库蓝图文档.md`  
  - 在「API 契约摘要」中，将“导入 API”一行更新为：请求参数 `start_date, end_date, limit`，响应体 `{imported_count, updated_count}`。  
- `LPS_creativ/LPS/docs/接口约定.md`  
  - 新增章节描述 `POST /api/videos/sync` 的方法、路径、参数、字段映射与响应示例。  
  - 说明 Upsert 策略，以及异常场景的错误返回。  

---

## 2025-11-25：视频封面本地上传 + 文档与协作指引整理

### 1）后端：`POST /api/videos/{id}/poster` 本地封面上传

- 文件：`LPS_creativ/LPS/backend/app/api/videos.py`。  
- 新增接口：`POST /api/videos/{video_id}/poster`。  
  - 接收参数：  
    - `video_id`（路径参数）。  
    - `file`（multipart/form-data 中的图片文件）。  
  - 校验：  
    - 若对应 `video` 不存在，返回 `code = 1, message = "video {id} not found"`。  
    - 若上传文件的 `content_type` 不是 `image/*`，返回 `code = 1, message = "仅支持上传图片文件"`。  
  - 存储逻辑：  
    - 生成目录：`backend/generated/video_posters/{video_id}/`（自动创建）。  
    - 文件名：`poster.{ext}`，`{ext}` 来自原始文件名后缀（默认为 `.jpg`）。  
    - 写入后，生成访问路径：`/generated/video_posters/{video_id}/poster.{ext}`，并写回 `video.poster_url`。  
  - 返回：`{ code: 0, message: "ok", data: { poster_url } }`。  
  - 注意：`POST /api/videos/sync` 在 upsert 时不会覆盖已有的 `poster_url`，因此人工上传封面不会被排行榜导入覆盖。

### 2）前端：视频列表「修改封面」操作

- 文件：`LPS_creativ/LPS/frontend/src/pages/VideoListPage.tsx`。  
- 在视频列表的操作列中增加「修改封面」按钮：  
  - 点击后打开本地文件选择对话框，仅允许选择图片。  
  - 选中文件后，调用封装好的 `uploadVideoPoster(video.id, file)`，向 `POST /api/videos/{id}/poster` 上传。  
  - 上传成功后弹出成功提示，并通过 React Query 失效 `['videos']` 缓存，自动刷新列表。  
- 列表中的封面字段现在既可能是外部 URL，也可能是 `/generated/video_posters/...` 的本地路径，展示逻辑保持一致。

### 3）文档与协作规范的整理

- `LPS_creativ/LPS/docs/接口约定.md`  
  - 新增接口说明：`POST /api/videos/{id}/poster`。  
  - 在视频列表接口说明中补充 `updated_at` 字段的含义（用于前端“获取时间”列）。  
  - 明确 STCine 同步接口为正式实现，而非占位。  
- `LPS_creativ/LPS/docs/数据库设计说明.md`  
  - 在 `video.poster_url` 字段说明中补充：该字段既可以存储外部图片链接，也可以存储本地上传后的路径（如 `/generated/video_posters/{id}/poster.jpg`）。  
- `LPS_creativ/Test/数据库蓝图文档.md`  
  - 在「API 契约摘要」中为视频模块新增一行：`POST /api/videos/{id}/poster`，请求为 `file`，响应为 `{poster_url}`。  
- `LPS_creativ/LPS/docs/新会话指引.md`  
  - 重新整理，使其涵盖：  
    - 当前已实现的功能模块。  
    - STCine 同步的真实行为。  
    - 视频封面上传能力及本地存储路径。  
  - 明确新的协作习惯：  
    - 实现功能前先用简短文字说明设计方案和改动文件，询问用户是否按该方案执行；  
    - 功能完成后先解释改动，再询问是否需要同步到文档；  
    - 用户只负责指挥，不直接写代码或修改 `.env`，由 AI 负责具体实现与运行。

### 4）当前效果与后续计划

- 现在导入 STCine 排行数据后，美工可以对任意视频手动上传更合适的封面图，并确保后续批量同步不会把封面覆盖掉。  
- 封面字段统一走 `poster_url`，既兼容外链，也支持本地上传路径，方便未来接入更多视频来源。  
- 新会话指引已经对“文档驱动 + 先说方案再写代码 + 用户不写代码”的协作习惯进行了明确说明，方便下一次会话的 AI 快速对齐风格。  

