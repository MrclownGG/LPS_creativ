# 开发日志 / 进度记录

本文件用于记录项目开发的关键步骤，方便：

- 新开会话时快速了解“已经做到哪一步了”
- 回溯某个功能是哪一天、在哪些文件中实现的

时间以你本地时间为准（大致记录即可）。

---

## 2025-11-21：后端基础骨架 + 数据库结构 + 视频列表接口

### 1）后端基础骨架（FastAPI）

- 目录：`LPS_creativ/LPS/backend`
- 主要文件：
  - `app/main.py`
    - 创建 FastAPI 应用
    - 提供基础接口：
      - `GET /health`：服务健康检查
      - `GET /db-check`：数据库连通性检查
  - `app/core/config.py`
    - 使用 `.env` 加载配置（环境、API 版本、`DATABASE_URL` 等）
  - `app/db/session.py`
    - 创建 SQLAlchemy `Engine` 和 `SessionLocal`
    - 提供 `get_db()` 作为 FastAPI 依赖
    - 提供 `get_db_health()` 做数据库健康检查

### 2）数据库结构（PostgreSQL + Alembic）

- 使用 PostgreSQL，示例数据库名：`lps_creativ`
- 通过 Alembic 初始化迁移：
  - 配置文件：`backend/alembic.ini`
  - 迁移 env：`backend/migrations/env.py`（已接入应用配置和 ORM 模型）
  - 首次迁移文件：
    - `backend/migrations/versions/27cb92c5c256_create_core_tables.py`
    - 创建 8 张核心表：`video` / `template` / `workflow` / `landing_page` / `ad_image_library` / `workflow_ad_map` / `campaign` / `campaign_workflow_map`
- ORM 模型定义：
  - `backend/app/db/models.py`
  - 详细字段说明见：`LPS/docs/数据库设计说明.md`

本地已完成：

- `alembic revision -m "create core tables" --autogenerate`
- `alembic upgrade head`
- 在 DBeaver 中确认表结构已经创建成功

### 3）视频列表接口：`GET /api/videos`

- 路由文件：`backend/app/api/videos.py`
- 注册：`app.include_router(videos_router, prefix="/api")`
- 接口定义：
  - 路径：`GET /api/videos`
  - 查询参数：`category`、`page`、`page_size`
  - 返回：`{ code, message, data: { total, items } }`
- 文档：`LPS/docs/接口约定.md` 中的 “2.3 查询视频列表”

本地已完成：

- 在 `video` 表中插入测试数据（包含 `metadata` 和 `status`）
- 用浏览器访问 `http://127.0.0.1:8000/api/videos?page=1&page_size=20` 验证

### 4）CORS 配置（解决前端跨域）

- 问题场景：
  - 后端（8000）接口正常返回数据
  - 前端（5173）始终显示“暂无数据”
- 原因：
  - 前端：`http://127.0.0.1:5173`
  - 后端：`http://127.0.0.1:8000`
  - 未配置 CORS，浏览器跨域请求被拦截
- 解决：
  - 在 `app/main.py` 中添加 `CORSMiddleware`
  - 允许来源：`http://127.0.0.1:5173`、`http://localhost:5173`
  - 重启 uvicorn 后，前端可以正常获取数据

---

## 2025-11-21：前端框架搭建 + 视频列表页面（只读）

### 1）前端框架（Vite + React + TS + AntD）

- 目录：`LPS_creativ/LPS/frontend`
- 使用 Vite 模板初始化：`react-ts`
- 安装的主要依赖：
  - `antd`
  - `@tanstack/react-query` / `@tanstack/react-query-devtools`
  - `axios`
  - `zustand`
  - `react-router-dom`
  - `dayjs`

入口文件：

- `src/main.tsx`：挂载 React 根组件  
- `src/App.tsx`：
  - 使用 `QueryClientProvider` 包裹  
  - 使用 Ant Design `ConfigProvider` 设置中文 locale 和主题  
  - 初期渲染 `<VideoListPage />`

样式：

- `src/index.css`：简化为后台风格背景  
- `src/App.css`：`app-root` 基本容器样式

### 2）视频列表页面（只读）

- 文件：`src/pages/VideoListPage.tsx`
- 使用组件：
  - `Layout + Header + Content`
  - `Card`
  - `Table`
  - `Input.Search`
- 数据获取：
  - `src/api/client.ts`：Axios 实例（`baseURL = http://127.0.0.1:8000/api`）  
  - `src/api/videos.ts`：
    - 类型：`Video`、`VideoListData`、`VideoListParams`  
    - `getVideos(params)` 调用 `/api/videos`  
    - `useVideos(params)` 使用 React Query 封装
- 功能：
  - 列表展示：ID / 标题 / 分类 / 海报 URL / 观看量  
  - 搜索：前端过滤（标题或分类包含关键字）

本地已完成：

- 后端：`uvicorn app.main:app --reload --port 8000`  
- 前端：`npm run dev`（默认 `http://127.0.0.1:5173`）  
- 在浏览器中看到：
  - 顶部标题：“LPS Creativ · 影片素材库”
  - 表格中显示测试视频数据

---

## 2025-11-21：视频模块 CRUD（手动导入 / 编辑 / 删除）

### 1）后端：视频新增 / 编辑 / 删除接口

- 文件：`backend/app/api/videos.py`

新增/完善：

- `POST /api/videos`（手动导入视频）
  - 请求体：`external_id?`, `title`, `category?`, `poster_url`, `view_count?`
  - 响应：`{ code, message, data: VideoItem }`
- `PUT /api/videos/{id}`（编辑视频）
  - 请求体：同上（主要更新 title/category/poster_url/view_count）
  - 响应：`{ code, message, data: VideoItem }`
- `DELETE /api/videos/{id}`（删除视频）
  - 当前为硬删除：直接从 `video` 表删除记录

接口说明已同步到：`LPS/docs/接口约定.md` 的相关小节。

### 2）前端：视频增删改查 + 搜索

- 文件：`frontend/src/pages/VideoListPage.tsx`
- 增加了：
  - “新增视频”按钮 + Modal 表单
  - 编辑 / 删除操作列
  - 本地搜索框（按标题或分类过滤）
- 使用 React Query 的 `useMutation` 管理 `createVideo` / `updateVideo` / `deleteVideo`，操作成功后自动刷新列表。

---

## 2025-11-21：模板管理 + 落地页工作流基础

### 1）模板目录与模板元数据接口

- 模板文件目录：`LPS_creativ/LPS/templates/home/`
  - 包含：`index.html` + `css/` / `js/` / `images/` 等静态资源
- 后端模板接口：`backend/app/api/templates.py`
  - `GET /api/templates`：按状态和分页查询模板列表
  - `POST /api/templates`：手动注册模板（`name` / `description` / `thumbnail_url` / `html_file_path` / `max_videos` / `static_assets_path` / `status`）
  - `PUT /api/templates/{id}`：编辑模板信息
  - `DELETE /api/templates/{id}`：删除模板（当前为硬删除）
- 接口约定同步在：`LPS/docs/接口约定.md` 的 2.7–2.10 小节。

### 2）前端模板管理页面

- 文件：`frontend/src/pages/TemplateListPage.tsx`
  - 使用 `useTemplates` 调用模板列表接口
  - 展示字段：ID / 名称 / 最大视频数 / 状态 / HTML 路径 / 描述
  - 支持：
    - 按状态过滤（active / inactive）
    - 新建 / 编辑 / 删除模板元数据
    - 默认示例模板指向 `home` 模板路径

### 3）落地页工作流接口（初版）

- 文件：`backend/app/api/workflows.py`
- 已实现：
  - `GET /api/workflows`：按状态和分页查询工作流列表
  - `POST /api/workflows`：创建工作流批次（初始状态 `draft`）
  - `GET /api/workflows/{id}`：查询工作流详情（包含其下 `landing_page` 列表）
  - `POST /api/workflows/{id}/generate`：
    - 根据 `video_ids[]` + `template_ids[]` 生成 `landing_page` 记录
    - 校验：模板存在；`video_ids.length >= template.max_videos`；同一 `(workflow_id, template_id)` 不重复生成
    - 简单策略：每个模板取前 `max_videos` 个视频
    - 生成后将 `workflow.status` 从 `draft` 更新为 `pending_ad`
  - `POST /api/workflows/{id}/archive`：
    - 仅允许对 `status = ready` 的工作流执行归档操作
    - 成功后将状态置为 `archived`

接口细节参见：`LPS/docs/接口约定.md` 中工作流相关小节。

### 4）前端：工作流列表 / 详情 / 生成页

- 工作流列表页：`frontend/src/pages/WorkflowListPage.tsx`
  - 使用 `useWorkflows` 调用 `GET /api/workflows`
  - 状态映射（中文）：
    - `draft`：草稿
    - `generating`：生成中（预留）
    - `pending_ad`：广告待上传
    - `ready`：准备完成（待投流）
    - `in_use`：已投放
    - `archived`：已归档
  - 表格列：ID / 批次名称 / 状态 / 落地页数量 / 创建人 / 创建时间 / 操作
  - 操作：
    - “查看详情” → `/workflows/{id}`
    - “生成落地页” → `/workflows/{id}/generate`（仅 `draft` 状态可用）
  - 顶部：
    - 按状态筛选（Select）
    - “新建落地页批次”按钮：
      - 打开 Modal 表单（批次名称 / 创建人）
      - 提交后调用 `POST /api/workflows`

- 工作流详情页：`frontend/src/pages/WorkflowDetailPage.tsx`
  - 使用 `useWorkflowDetail(workflowId)`
  - 展示：
    - 基本信息：名称 / ID / 创建人 / 创建时间 / 当前状态
    - 下方表格：当前批次下所有 `landing_page`
      - 字段：ID / template_id / selected_video_ids（以逗号分隔）/ generated_page_url

- 生成落地页页：`frontend/src/pages/WorkflowGeneratePage.tsx`
  - 使用：
    - `useVideos`（拉取可选视频，当前简单拉取前 100 条）
    - `useTemplates`（拉取 `status=active` 的模板，简单拉取前 100 条）
  - UI：
    - Step 1：视频列表（多选）
    - Step 2：模板列表（多选）
    - 底部：`生成落地页` 按钮
  - 初始本地校验逻辑（旧版）：
    - 未选择视频或模板：
      - 使用 `Modal.warning` 提示“请至少选择 1 个视频和 1 个模板”
    - 选中的模板列表为空：
      - 使用 `Modal.error` 提示“选中的模板不存在，请刷新页面后重试”
    - 若所选模板中最大的 `max_videos` > 当前选中视频数：
      - 使用 `Modal.error` 提示需要的视频数量与当前选择数量的差异
    - 仅在上述校验全部通过时，才调用 `generateWorkflow` 请求后端

---

## 2025-11-21：当前已知问题 / 待解决事项（初版）

> 重要：下一次新会话接手开发时，请优先关注这一节（后续条目会在修复后更新状态）。

- 问题 1：落地页生成页的本地校验弹窗行为  
  - 场景：
    - 模板 `max_videos = 3`，用户只勾选 2 个视频，点击“生成落地页”
  - 预期：
    - 触发 `validateSelection()`，调用 `Modal.error` 提示数量不够，不发送后端请求
  - 用户反馈：
    - 实际在本地测试时，点击按钮后页面完全无明显变化，没有看到弹窗
    - 浏览器控制台无报错
  - 当前代码：
    - `WorkflowGeneratePage.tsx` 中的 `validateSelection()` 已包含上述 `Modal.error` 调用
    - 按理应当显示弹窗，但用户端显示“没有任何提示”
  - 后续建议（旧）：
    - 新会话接手时，在本地复现该场景：
      - 确保前端 dev server 使用最新代码；
      - 在 `/workflows/{id}/generate` 选择数量不足的视频和模板；
      - 检查是否走到 `validateSelection`（可以临时加 `console.log`）；
      - 如需要，可简化校验逻辑以确认 Modal 是否正常渲染。

- 问题 2：`generated_page_url` 为占位  
  - 当前生成的 URL 形如 `/generated/{workflow_id}/{template_id}.html`
  - 尚未实现实际 HTML 渲染和静态文件输出
  - 需要后续设计模板渲染管道（基于 `LPS/templates/home`）

- 其他未实现但已在蓝图中的功能：
  - 工作流归档操作在前端列表未开放按钮（后端接口已存在）
  - 广告图上传与关联逻辑（`ad_image_library` / `workflow_ad_map`）
  - 投放计划模块（`campaign`）

> 注：问题 1、问题 2 后续在 2025-11-24 已部分完成并在下文更新。

---

## 2025-11-24：落地页生成页本地校验弹窗问题修复（前端）

- 问题背景  
  - 页面：`/workflows/:workflowId/generate`（`WorkflowGeneratePage.tsx`）
  - 场景：模板 `max_videos = 3`，用户只选择 2 个视频后点击“生成落地页”
  - 预期：前端在 `validateSelection()` 中拦截，弹出“最大需要 3 个视频，你只选了 2 个”的错误弹窗，不调用后端接口
  - 实际：点击按钮后界面完全无变化，没有任何弹窗；浏览器控制台也无报错

- 根因分析  
  - 前端技术栈为 `react@19` + `antd@5.29.x`  
  - 使用了 antd 的静态调用方式：`Modal.error / Modal.warning / Modal.info`
  - antd v5 在 React 18+ 下推荐通过 `<App />` 提供上下文，再通过 `App.useApp().modal` 创建对话框实例
  - 静态 `Modal.xxx` 在当前组合下无法正确消费 App / 主题上下文，导致对话框“静默失败”（不渲染、不报错）
  - 同时，`Table.rowSelection.selectedRowKeys` 在运行时可能是 `string[]`，而模板 `id` 是 `number`，直接使用 `includes` 匹配会失败，导致选中模板列表为空

- 修复方案  
  1. 全局接入 AntD App 上下文  
     - 文件：`LPS_creativ/LPS/frontend/src/App.tsx`  
     - 从 `antd` 引入 `App as AntdApp`，使用 `<AntdApp>` 包裹 `BrowserRouter`：  
       - `ConfigProvider` → `AntdApp` → `BrowserRouter` → `Routes`  
     - 为整个前端提供统一的 AntD App context
  2. 生成页改为使用 `modal` 实例  
     - 文件：`LPS_creativ/LPS/frontend/src/pages/WorkflowGeneratePage.tsx`  
     - 通过 `const { modal } = App.useApp()` 获取 `modal` 实例  
     - 将所有 `Modal.warning / Modal.error / Modal.info` 改为 `modal.warning / modal.error / modal.info`  
     - 保持业务逻辑不变：未选视频/模板、模板不存在、视频数量不足都弹出对应错误提示
  3. 统一模板 ID 类型  
     - 在 `validateSelection` 中，将选中的模板 ID 统一转为数字：  
       - 使用 `const selectedIdSet = new Set(selectedTemplateIds.map(id => Number(id)))`  
       - 使用 `templates.filter(t => selectedIdSet.has(Number(t.id)))` 匹配  
     - 避免 `selectedRowKeys` 为 `string[]` 时无法匹配导致“选中的模板列表为空”

- 验证结果  
  - 在 Firefox / Chrome 下测试：  
    - 当 `max_videos = 3` 且只选 2 个视频时，点击“生成落地页”，会弹出错误弹窗，说明本地校验已生效  
    - 当选择数量满足要求时，调用后端接口成功，并跳转回工作流列表

- 后续约定  
  - 新页面如需使用 AntD 弹窗，应优先通过 `App.useApp().modal` 获取实例方法，不再使用静态 `Modal.xxx`  
  - 当涉及 `Table.rowSelection.selectedRowKeys` 与实体 ID 匹配时，要注意运行时类型可能为 `string[]`，需要统一转换再比较

---

## 2025-11-24：前后端增加“删除工作流批次”能力

- 背景  
  - 需求：在落地页工作流列表中，为每条工作流增加“删除”操作  
  - 期望：删除批次及其落地页记录，但不影响素材库和模板库

- 后端改动  
  - 文件：`LPS_creativ/LPS/backend/app/api/workflows.py`  
  - 新增接口：`DELETE /api/workflows/{workflow_id}`  
    - 成功：返回 `{ code: 0, message: "ok", data: {} }`  
    - 未找到：返回 `{ code: 1, message: "workflow {id} not found", data: {} }`  
  - 状态限制：不限制工作流状态，`draft` / `pending_ad` / `pending_ad` / `ready` / `in_use` / `archived` 均可删除  
  - 级联删除（依赖数据库 ON DELETE CASCADE 配置）：  
    - 会删除：
      - 当前 `workflow` 记录本身  
      - 隶属于该 workflow 的所有 `landing_page` 记录  
      - `workflow_ad_map` 中与该 workflow 相关的关联记录  
    - 不会删除：
      - 视频素材表 `video`  
      - 模板表 `template`  
      - 广告图素材表 `ad_image_library`  
      - 其他 workflow 及其落地页记录

- 前端改动  
  - 文件：`LPS_creativ/LPS/frontend/src/api/workflows.ts`  
    - 新增 `deleteWorkflow(id: number)`，调用 `DELETE /api/workflows/{id}`  
  - 文件：`LPS_creativ/LPS/frontend/src/pages/WorkflowListPage.tsx`  
    - 在操作列中为每条工作流增加“删除”按钮  
    - 使用 AntD `Popconfirm` 做二次确认：
      - 文案提示“删除后将无法恢复，但不会影响素材库和模板”  
    - 确认后调用 `deleteMutation.mutate(record.id)`，成功时展示提示并通过 `invalidateQueries(['workflows'])` 刷新列表

- 影响范围  
  - 允许运营在任何状态下清理由于测试或不再需要的工作流批次  
  - 不影响已经入库的素材数据和模板定义，符合蓝图的级联删除策略

---

## 2025-11-24：模板渲染静态 HTML + 落地页预览能力

- 背景  
  - 之前 `generated_page_url` 仅为占位字符串（`/generated/{workflow_id}/{template_id}.html`），未实际输出 HTML 文件  
  - 使用模板时需要手工输入 URL 才能查看效果，且页面内容与选中视频没有耦合  
  - 期望：生成落地页时实际渲染 HTML 文件，并在“生成落地页”页面提供预览入口

- 后端改动：渲染落地页 HTML 并输出到磁盘  
  - 文件：`LPS_creativ/LPS/backend/app/api/workflows.py`  
  - 在 `generate_landing_pages` 中：
    - 从 `Template.html_file_path` 读取模板 HTML（兼容多种写法，例如 `LPS/templates/home/index.html`、`templates/home/index.html` 等）  
    - 将模板中的静态资源路径 `href="./..."` / `src="./..."` 改写为 `/templates/...` 形式的绝对路径，以便通过 FastAPI 静态目录访问  
    - 在 HTML 中注入选中视频 ID 的 JSON：
      - `<script id="lps-selected-videos" type="application/json">[101,102,103]</script>`
    - 将最终 HTML 写入：`backend/generated/{workflow_id}/{landing_page_id}.html`  
    - 更新 `LandingPage.generated_page_url` 为 `/generated/{workflow_id}/{landing_page_id}.html`  
    - 保持原有业务逻辑：生成成功后将 `workflow.status` 从 `draft` 更新为 `pending_ad`
  - 文件：`LPS_creativ/LPS/backend/app/main.py`  
    - 使用 `StaticFiles` 挂载静态目录：
      - `/generated` → `backend/generated`（访问生成的落地页 HTML）  
      - `/templates` → `LPS/templates`（访问模板 CSS/JS/图片等静态资源）

- 后端改动：新增预览接口（不落库）  
  - 文件：`LPS_creativ/LPS/backend/app/api/workflows.py`  
  - 新增接口：`POST /api/workflows/preview`  
    - 请求体：`{ video_ids: number[], template_id: number }`  
    - 行为：
      - 按模板的 `max_videos` 校验 `video_ids` 数量是否足够  
      - 复用与正式生成相同的渲染逻辑（静态资源修正 + 注入 JSON）  
      - 将 HTML 写入 `backend/generated/preview/{template_id}_{uuid}.html`  
      - 返回 `preview_url = "/generated/preview/{filename}.html"`  
    - 不会创建 `landing_page` 记录，也不会修改任何 `workflow` 状态

- 前端改动：生成页“预览”按钮 + Modal + iframe 预览  
  - 文件：`LPS_creativ/LPS/frontend/src/api/workflows.ts`  
    - 新增 `previewWorkflow(payload: { video_ids: number[]; template_id: number })` 调用 `POST /api/workflows/preview`，返回 `preview_url` 字符串  
  - 文件：`LPS_creativ/LPS/frontend/src/pages/WorkflowGeneratePage.tsx`  
    - 在“生成落地页”按钮右侧增加“预览”按钮：  
      - 复用 `validateSelection()` 做本地数量校验（确保视频数量满足所选模板中最大 `max_videos` 要求）  
      - 当前版本仅支持单个模板预览：当勾选多个模板时，弹出 `modal.warning` 提示“预览仅支持单个模板”  
      - 通过 `previewWorkflow` 调用后端预览接口，拿到 `preview_url` 后：  
        - 计算后端基础地址：`backendBaseUrl = apiClient.defaults.baseURL?.replace(/\/api\/?$/, '')`  
        - 在一个 `Modal` 中使用 `<iframe src={backendBaseUrl + preview_url}>` 渲染预览页面  
        - 预览弹窗宽度约为 80%，高度约 70vh，便于查看整体效果

- 当前效果与后续计划  
  - 现在 `generated_page_url` 已对应真实可访问的静态 HTML 文件路径，`LandingPage` 列表中的 URL 可以直接打开查看页面  
  - 在落地页生成页中，用户可以在选择视频和模板后通过“预览”按钮快速查看渲染效果，而无需手工输入 URL  
  - 目前模板内容仍然是静态 HTML（未根据视频元数据替换文案/图片），后续需要设计占位符规则（例如 `{{VIDEO_1_TITLE}}`、`{{VIDEO_1_POSTER_URL}}`），并在渲染函数中根据 `selected_video_ids` 查询 `video` 表后替换对应位置  
  - 预览接口已复用与正式生成相同的渲染管道，后续在引入占位符替换时，两者会保持一致的视觉效果

