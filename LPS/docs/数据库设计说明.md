# 数据库设计说明（与蓝图 V1.4 对齐）

本文档描述后端实际使用的 PostgreSQL 表结构，与
`LPS_creativ/Test/数据库蓝图文档.md` 中的蓝图 V1.4 一一对应。

当前所有表已通过 Alembic 迁移创建，迁移文件位于：

- `LPS_creativ/LPS/backend/migrations/versions/27cb92c5c256_create_core_tables.py`

## 1. 总体说明

- 数据库：PostgreSQL（本地示例：`lps_creativ`）
- 所有 ORM 模型定义在：
  - `LPS_creativ/LPS/backend/app/db/models.py`
- ORM 基类：
  - `LPS_creativ/LPS/backend/app/db/base.py` 中的 `Base`
- 迁移管理：
  - `alembic`，配置文件在 `LPS_creativ/LPS/backend/alembic.ini`

后续如需对表结构调整，应优先修改 ORM 模型，然后通过 Alembic 自动生成迁移。

---

## 2. 表：`video`（视频素材库）

对应蓝图实体 1。

文件位置：`app/db/models.py` 中的 `Video`。

核心字段：

- `id BIGINT`：主键，自增
- `external_id VARCHAR(64)`：外部视频系统的唯一 ID（唯一索引）
- `title VARCHAR(255)`：标题，必填
- `category VARCHAR(50)`：分类（例如：教程、宣传片）
- `poster_url TEXT`：海报图 URL，必填
- `view_count BIGINT`：观看量，默认 0
- `metadata JSONB`：额外元数据（例如时长、标签），默认为空对象 `{}`  
  - 在 ORM 中属性名为 `metadata_`，列名为 `metadata`（避免 SQLAlchemy 保留字冲突）
- `status VARCHAR(20)`：状态，默认 `'active'`
- `created_at TIMESTAMP`：创建时间，默认 `NOW()`
- `updated_at TIMESTAMP`：更新时间，默认 `NOW()`，更新时自动刷新

索引：

- 唯一索引：`idx_video_external_id(external_id)`（通过 `unique=True` 实现）
- 普通索引：
  - `idx_video_category(category)`
  - `idx_video_status(status)`

用途：

- 存储从外部视频系统同步来的视频基础信息。
- 后续 `landing_page.selected_video_ids` 中的 ID 将引用此表的主键。

---

## 3. 表：`template`（落地页模板库）

对应蓝图实体 2。

文件位置：`app/db/models.py` 中的 `Template`。

核心字段：

- `id BIGINT`：主键，自增
- `name VARCHAR(100)`：模板名称
- `description TEXT`：描述
- `thumbnail_url TEXT`：缩略图 URL
- `html_file_path TEXT`：模板 HTML 文件路径（在服务器上的存储路径）
- `max_videos INT`：该模板允许放置的视频数量上限
- `static_assets_path TEXT`：静态资源路径（CSS / JS / 图片等所在目录）
- `status VARCHAR(20)`：状态，默认 `'active'`
- `created_at TIMESTAMP`：创建时间，默认 `NOW()`

用途：

- 表示可供选择的落地页模板。
- 在生成落地页时，`landing_page.template_id` 外键指向此表。

---

## 4. 表：`workflow`（工作流 / 批次）

对应蓝图实体 3。

文件位置：`app/db/models.py` 中的 `Workflow`。

核心字段：

- `id BIGINT`：主键，自增
- `name VARCHAR(200)`：批次名称（由美工命名）
- `status VARCHAR(30)`：状态
  - 流程：`draft` → `generating` → `pending_ad` → `ready` → `archived`
- `created_by VARCHAR(100)`：创建者（用户名或工号）
- `created_at TIMESTAMP`：创建时间，默认 `NOW()`
- `updated_at TIMESTAMP`：更新时间，默认 `NOW()`，更新时自动刷新

索引：

- `idx_workflow_creator(created_by)`
- `idx_workflow_status(status)`

用途：

- 表示一次完整的落地页生成批次，是数据组织与状态管理的核心实体。
- 与 `landing_page` 为一对多关系（一个 workflow 下有多个落地页）。

---

## 5. 表：`landing_page`（落地页实例）

对应蓝图实体 4。

文件位置：`app/db/models.py` 中的 `LandingPage`。

核心字段：

- `id BIGINT`：主键，自增
- `workflow_id BIGINT`：外键，指向 `workflow.id`，`ON DELETE CASCADE`
- `template_id BIGINT`：外键，指向 `template.id`
- `selected_video_ids BIGINT[]`：选择的视频 ID 数组
  - 这些 ID 对应 `video.id`
  - 体现了“一个落地页被多个视频组成”的关系
- `generated_page_url TEXT`：生成后的落地页 HTML 访问 URL 或存储路径
- `created_at TIMESTAMP`：创建时间，默认 `NOW()`

约束与索引：

- 唯一约束：`UNIQUE(workflow_id, template_id)`
  - 在同一个 workflow 下，同一模板只生成一个落地页实例
- 索引：
  - `idx_landing_page_workflow(workflow_id)`
  - `idx_landing_page_template(template_id)`

用途：

- 存储每个批次中，具体某个模板和视频组合生成出的单个落地页实例。

---

## 6. 表：`ad_image_library`（广告图素材总库）

对应蓝图实体 5。

文件位置：`app/db/models.py` 中的 `AdImageLibrary`。

核心字段：

- `id BIGINT`：主键，自增
- `file_url TEXT`：文件访问 URL
- `file_name VARCHAR(255)`：原始文件名
- `dimensions VARCHAR(20)`：尺寸，例如 `"1080x1920"`
- `file_size INT`：文件大小（字节）
- `author VARCHAR(100)`：上传者
- `upload_batch VARCHAR(50)`：上传批次标识（可用于按批次筛选）
- `status VARCHAR(20)`：状态，默认 `'active'`
- `created_at TIMESTAMP`：上传时间，默认 `NOW()`

索引：

- `idx_ad_image_author(author)`
- `idx_ad_image_batch(upload_batch)`

用途：

- 作为全局广告素材库，供多个 workflow 复用。
- 不直接关联 `landing_page` 或 `video`，仅通过中间表与 `workflow` 关联。

---

## 7. 表：`workflow_ad_map`（批次与广告图关联表）

对应蓝图实体 6。

文件位置：`app/db/models.py` 中的 `WorkflowAdMap`。

核心字段：

- `workflow_id BIGINT`：外键，指向 `workflow.id`，`ON DELETE CASCADE`
- `ad_image_id BIGINT`：外键，指向 `ad_image_library.id`，`ON DELETE CASCADE`

主键与索引：

- 复合主键：`PRIMARY KEY (workflow_id, ad_image_id)`
- 索引：
  - `idx_wam_workflow(workflow_id)`
  - `idx_wam_ad_image(ad_image_id)`

用途：

- 实现 workflow 与广告图 N:N 的关联。
- 当 workflow 被删除时，自动删除对应关联记录，但广告素材本身保留。

---

## 8. 表：`campaign`（投放计划）

对应蓝图实体 7。

文件位置：`app/db/models.py` 中的 `Campaign`。

核心字段：

- `id BIGINT`：主键，自增
- `name VARCHAR(200)`：投放计划名称
- `channels TEXT[]`：渠道数组（例如：`["FB", "IG"]`）
- `regions TEXT[]`：地区数组（例如：`["US", "CA"]`）
- `launch_time TIMESTAMP`：计划启动时间（可选）
- `status VARCHAR(20)`：状态，默认 `'active'`
- `created_by VARCHAR(100)`：创建人
- `created_at TIMESTAMP`：创建时间，默认 `NOW()`
- `config JSONB`：额外配置（预算、出价策略等），默认为 `{}`。

索引：

- `idx_campaign_creator(created_by)`

用途：

- 表示一次投放计划，内部会关联多个 ready 状态的 workflow。

---

## 9. 表：`campaign_workflow_map`（投放计划与批次关联）

对应蓝图实体 8。

文件位置：`app/db/models.py` 中的 `CampaignWorkflowMap`。

核心字段：

- `campaign_id BIGINT`：外键，指向 `campaign.id`，`ON DELETE CASCADE`
- `workflow_id BIGINT`：外键，指向 `workflow.id`，`ON DELETE CASCADE`

主键与索引：

- 复合主键：`PRIMARY KEY (campaign_id, workflow_id)`
- 索引：
  - `idx_cwm_campaign(campaign_id)`
  - `idx_cwm_workflow(workflow_id)`

用途：

- 实现投放计划与 workflow 之间的 N:N 关系。
- 删除某个投放计划时，仅删除关联关系，workflow 本身保留。

---

## 10. 级联删除与数据安全

与蓝图第 5 章的“级联删除策略”对应，当前实现遵循：

- 删除 `workflow`：
  - 自动删除：
    - `landing_page` 中所有属于该 workflow 的记录（通过 `ON DELETE CASCADE`）
    - `workflow_ad_map` 中与该 workflow 相关的记录
  - 不删除：
    - `ad_image_library` 中的广告图
    - `campaign_workflow_map`（通过业务接口控制）

- 删除 `ad_image_library`：
  - 自动删除：
    - `workflow_ad_map` 中与该广告图相关的记录
  - 不删除：
    - `workflow` / `landing_page`

- 删除 `campaign`：
  - 自动删除：
    - `campaign_workflow_map` 中与该计划相关的记录
  - 不删除：
    - `workflow` / `landing_page` / `ad_image_library`

---

## 11. 迁移使用说明（简要）

在 `LPS_creativ/LPS/backend` 目录下：

1. 自动生成迁移（当修改了 `models.py` 时）：

   ```bash
   alembic revision -m "描述本次变更" --autogenerate
   ```

2. 应用最新迁移：

   ```bash
   alembic upgrade head
   ```

3. 回滚到上一个版本（仅在开发环境使用）：

   ```bash
   alembic downgrade -1
   ```

> 注意：表结构的任何变更都应该通过 ORM + Alembic 迁移来进行，
> 不建议直接在数据库中手工 `ALTER TABLE`，否则会导致代码与实际结构不一致。

---

## 12. 补充说明：`generated_page_url` 实际含义

- 字段位置：`landing_page.generated_page_url`  
- 类型：`TEXT`  
- 作用：存储生成后的落地页 HTML 的访问 URL / 存储路径。  
- 当前实现（2025-11-24 起）：  
  - 后端在调用 `POST /api/workflows/{id}/generate` 时，会读取模板 HTML、做简单替换并输出静态文件；  
  - 生成文件的物理路径：`LPS_creativ/LPS/backend/generated/{workflow_id}/{landing_page_id}.html`；  
  - 对外访问 URL：`/generated/{workflow_id}/{landing_page_id}.html`；  
  - 即：`generated_page_url` 字段中存储的就是上述 URL 字符串。  
- 注意：  
  - 模板静态资源（CSS/JS/图片等）会通过 `/templates/...` 路径暴露，对应 `LPS_creativ/LPS/templates` 目录；  
  - 若后续调整生成目录或 URL 规则，需要同步更新本说明。 
