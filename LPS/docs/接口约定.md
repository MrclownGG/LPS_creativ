# 接口约定

本文档定义 LPS Creativ 后端 API 的通用约定。  
每个功能模块的具体接口会在后续章节中逐步补充。

## 1. 统一返回格式

所有接口都使用统一的 JSON 包装结构：

- 成功：

```json
{
  "code": 0,
  "message": "ok",
  "data": { /* 具体数据 */ }
}
```

- 失败：

```json
{
  "code": 1,
  "message": "错误说明",
  "data": {
    "details": "更详细的错误信息（可选）"
  }
}
```

含义说明：

- `code`
  - `0`：表示成功
  - 非 `0`：表示有错误（业务错误或系统错误）
  - 后续会定义更细的错误码，例如：
    - `1001`：参数校验失败
    - `2001`：资源不存在
    - `3001`：外部视频 API 调用失败
    - `4001`：数据库操作异常
- `message`
  - 简短的人类可读说明（中英文均可）
  - 便于前端直接提示给用户，或用于日志排查
- `data`
  - 成功时含有实际业务数据
  - 失败时可以为空对象，或包含一些辅助信息（如字段错误列表）

当前已实现的接口 `/health`、`/db-check` 和 `/api/videos` 系列都遵循此约定。

## 2. 已实现接口

### 2.1 服务健康检查

- 方法：`GET`  
- 路径：`/health`  
- 功能：快速检查后端服务是否正常运行。

请求参数：无

成功响应示例：

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "service": "lps-backend",
    "version": "0.1.0",
    "environment": "local"
  }
}
```

### 2.2 数据库连通性检查

- 方法：`GET`  
- 路径：`/db-check`  
- 功能：检查后端是否能成功连接 PostgreSQL 数据库。

请求参数：无

成功响应示例：

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "status": "connected",
    "test_query_result": 1
  }
}
```

---

### 2.3 查询视频列表

- 方法：`GET`  
- 路径：`/api/videos`  
- 功能：按分类和分页查询视频素材列表。

#### 请求参数（query）

- `category`（可选，string）：视频分类，不传则返回所有分类。  
- `page`（可选，int，默认 `1`，>= 1）：页码，从 1 开始。  
- `page_size`（可选，int，默认 `20`，1–100）：每页数量。

#### 成功响应示例

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "total": 42,
    "items": [
      {
        "id": 123,
        "title": "示例视频标题",
        "poster_url": "https://example.com/poster.jpg",
        "category": "tutorial",
        "view_count": 1000
      }
    ]
  }
}
```

字段说明：

- `data.total`：符合条件的视频总数量（用于分页）。  
- `data.items`：当前页的视频列表。
  - `id`：视频主键 ID（`video.id`）  
  - `title`：视频标题  
  - `poster_url`：视频海报图 URL  
  - `category`：视频分类（可能为空）  
  - `view_count`：观看量

---

### 2.4 手动导入视频素材（新增）

- 方法：`POST`  
- 路径：`/api/videos`  
- 功能：通过表单手动录入或导入单条视频素材记录。

#### 请求体（JSON）

```json
{
  "external_id": "vid_001",
  "title": "测试视频 1",
  "category": "tutorial",
  "poster_url": "https://example.com/poster1.jpg",
  "view_count": 1000
}
```

字段说明：

- `external_id`（可选，string）
  - 外部视频系统的唯一 ID，用于对齐和去重
  - 手工录入的素材可以留空
- `title`（必填，string）：视频标题  
- `category`（可选，string）：视频分类（如 `"tutorial"`、`"promo"`）  
- `poster_url`（必填，string）：视频封面图 URL  
- `view_count`（可选，int，默认 `0`）：初始观看量

#### 成功响应示例

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "id": 5,
    "title": "测试视频 1",
    "poster_url": "https://example.com/poster1.jpg",
    "category": "tutorial",
    "view_count": 1000
  }
}
```

---

### 2.5 编辑视频素材

- 方法：`PUT`  
- 路径：`/api/videos/{id}`  
- 功能：根据 ID 更新一条视频素材的展示信息。

#### 路径参数

- `id`（必填，int）：要编辑的视频 ID（`video.id`）

#### 请求体（JSON）

结构与“手动导入”基本一致，外部 ID 通常不在此处修改：

```json
{
  "title": "测试视频 1 - 新标题",
  "category": "promo",
  "poster_url": "https://example.com/new-poster.jpg",
  "view_count": 2000
}
```

说明：

- 当前支持修改字段：
  - `title`
  - `category`
  - `poster_url`
  - `view_count`
- `external_id`、`metadata`、`status` 等字段由系统/同步逻辑维护，一般不通过此接口修改。

#### 成功响应示例

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "id": 5,
    "title": "测试视频 1 - 新标题",
    "poster_url": "https://example.com/new-poster.jpg",
    "category": "promo",
    "view_count": 2000
  }
}
```

---

### 2.6 删除视频素材

- 方法：`DELETE`  
- 路径：`/api/videos/{id}`  
- 功能：根据 ID 删除一条视频素材记录。

#### 路径参数

- `id`（必填，int）：要删除的视频 ID（`video.id`）

#### 成功响应示例

```json
{
  "code": 0,
  "message": "ok",
  "data": {}
}
```

#### 失败响应示例（视频不存在）

```json
{
  "code": 1,
  "message": "video 123 not found",
  "data": {}
}
```

说明：

- 当前实现为“硬删除”（直接从 `video` 表删除记录）  
- 将来如需改为“软删除”，可以改为更新 `status` 字段并在列表查询中过滤。

---

### 2.7 查询模板列表

- 方法：`GET`  
- 路径：`/api/templates`  
- 功能：按状态和分页查询模板列表。

#### 请求参数（query）

- `status`（可选，string）：模板状态（如 `active` / `inactive`）  
- `page`（可选，int，默认 `1`）：页码  
- `page_size`（可选，int，默认 `20`）：每页数量

#### 成功响应示例

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "total": 1,
    "items": [
      {
        "id": 1,
        "name": "首页模板 V1",
        "description": "静态首页落地页模板",
        "thumbnail_url": "/templates/home/images/banner1.jpg",
        "html_file_path": "LPS/templates/home/index.html",
        "max_videos": 3,
        "static_assets_path": "LPS/templates/home",
        "status": "active"
      }
    ]
  }
}
```

---

### 2.8 手动注册模板

- 方法：`POST`  
- 路径：`/api/templates`  
- 功能：将一套静态模板（HTML + 资源路径）注册到系统中。

#### 请求体（JSON）

```json
{
  "name": "首页模板 V1",
  "description": "静态首页落地页模板",
  "thumbnail_url": "/templates/home/images/banner1.jpg",
  "html_file_path": "LPS/templates/home/index.html",
  "max_videos": 3,
  "static_assets_path": "LPS/templates/home",
  "status": "active"
}
```

字段说明：

- `name`（必填）：模板名称  
- `description`（可选）：模板描述  
- `thumbnail_url`（可选）：缩略图 URL  
- `html_file_path`（必填）：模板 HTML 文件路径（相对或绝对）  
- `max_videos`（必填）：模板可容纳的视频数量上限  
- `static_assets_path`（可选）：静态资源路径（CSS/JS/图片目录）  
- `status`（可选，默认 `active`）：模板状态

#### 成功响应示例

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "id": 1,
    "name": "首页模板 V1",
    "description": "静态首页落地页模板",
    "thumbnail_url": "/templates/home/images/banner1.jpg",
    "html_file_path": "LPS/templates/home/index.html",
    "max_videos": 3,
    "static_assets_path": "LPS/templates/home",
    "status": "active"
  }
}
```

---

### 2.9 编辑模板信息

- 方法：`PUT`  
- 路径：`/api/templates/{id}`  
- 功能：根据 ID 更新模板的基础信息（名称、描述、路径等）。

请求体结构与“手动注册模板”相同。

成功响应结构同“手动注册模板”的成功响应。

---

### 2.10 删除模板

- 方法：`DELETE`  
- 路径：`/api/templates/{id}`  
- 功能：根据 ID 删除一条模板记录。

说明：

- 当前实现为“硬删除”（从 `template` 表删除记录）  
- 将来如需保留历史，可改为 `status = 'inactive'` 并在查询时过滤。

---

### 2.11 查询工作流列表

- 方法：`GET`  
- 路径：`/api/workflows`  
- 功能：按状态和分页查询落地页工作流批次列表。

#### 请求参数（query）

- `status`（可选，string）：工作流状态，例如 `draft` / `pending_ad` / `ready` / `archived`  
- `page`（可选，int，默认 `1`）  
- `page_size`（可选，int，默认 `20`）

#### 成功响应示例

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "total": 1,
    "items": [
      {
        "id": 1,
        "name": "测试批次 1",
        "status": "pending_ad",
        "created_by": "designer_a",
        "created_at": "2025-11-24T10:00:00",
        "landing_page_count": 2
      }
    ]
  }
}
```

---

### 2.12 创建工作流批次

- 方法：`POST`  
- 路径：`/api/workflows`  
- 功能：创建一个新的落地页工作流批次。

#### 请求体（JSON）

```json
{
  "name": "测试批次 1",
  "created_by": "designer_a"
}
```

字段说明：

- `name`（必填）：批次名称  
- `created_by`（可选）：创建者标识（用户名或工号），未提供时后端默认 `"system"`。

#### 成功响应示例

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "id": 1,
    "name": "测试批次 1",
    "status": "draft",
    "created_by": "designer_a",
    "created_at": "2025-11-24T10:00:00",
    "landing_page_count": 0
  }
}
```

---

### 2.13 查询工作流详情

- 方法：`GET`  
- 路径：`/api/workflows/{id}`  
- 功能：获取单个工作流批次及其下所有落地页的详细信息。

#### 成功响应示例

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "id": 1,
    "name": "测试批次 1",
    "status": "pending_ad",
    "created_by": "designer_a",
    "created_at": "2025-11-24T10:00:00",
    "updated_at": "2025-11-24T10:05:00",
    "landing_pages": [
      {
        "id": 10,
        "template_id": 1,
        "selected_video_ids": [101, 102, 103],
        "generated_page_url": "/generated/1/1.html"
      }
    ]
  }
}
```

---

### 2.14 生成落地页

- 方法：`POST`  
- 路径：`/api/workflows/{id}/generate`  
- 功能：根据选中的视频和模板，为指定工作流生成落地页记录。

#### 请求体（JSON）

```json
{
  "video_ids": [101, 102, 103],
  "template_ids": [1, 2]
}
```

说明：

- `video_ids`：选中的视频 ID 列表  
- `template_ids`：选中的模板 ID 列表  
- 后端会根据模板的 `max_videos` 校验视频数量是否足够：  
  - 若某模板需要 3 个视频而你只选了 2 个，则返回错误。

#### 成功响应示例

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "workflow_id": 1,
    "landing_pages": [
      {
        "id": 10,
        "template_id": 1,
        "selected_video_ids": [101, 102, 103],
        "generated_page_url": "/generated/1/1.html"
      },
      {
        "id": 11,
        "template_id": 2,
        "selected_video_ids": [101, 102, 103],
        "generated_page_url": "/generated/1/2.html"
      }
    ]
  }
}
```

状态说明：

- 当生成成功后，后端会将 `workflow.status` 从 `draft` 更新为 `pending_ad`（广告待上传）。  
- 未来如需支持异步生成，可以在此基础上增加 `generating` 中间状态。

---

### 2.15 归档工作流

- 方法：`POST`  
- 路径：`/api/workflows/{id}/archive`  
- 功能：将工作流状态置为 `archived`，表示该批次已结束，仅保留历史。

说明：

- 当前仅允许对 `status = ready` 的工作流执行归档操作。  
- 若状态不为 `ready`，接口会返回 `code = 1` 和错误信息。

## 3. 后续接口规划（概览）

根据已有的“数据库蓝图文档”，后端后续将增加以下模块的接口：

1. 视频素材（`video`）
   - 从外部视频系统同步热门视频（`POST /api/videos/sync`）
2. 模板管理（`template`）
   - 查询模板列表
   - 上传新模板（HTML 文件及元数据）
3. 工作流与落地页（`workflow` / `landing_page`）
   - 创建工作流批次
   - 选择视频与模板
   - 触发落地页生成（异步）
   - 查询批次详情与状态
4. 广告图素材库（`ad_image_library`）
   - 上传广告图
   - 关联到工作流批次
5. 投放计划（`campaign`）
   - 创建投放计划
   - 将 ready 状态的工作流批次加入计划
   - 生成并下载打包文件

这些接口会在实现时同步更新本文件。
> 前端补充说明（本地校验约定）  
> - 实际前端实现中，`/api/workflows/{id}/generate` 在调用前会做一次本地校验：  
>   - 根据所选模板的 `max_videos` 计算需要的视频数量上限；  
>   - 若当前选中的视频数量不足，则直接在前端弹出错误提示，不发送请求；  
> - 后端接口仍然会执行相同的数量校验，并在不满足时返回 `code = 1` 和错误 `message`；  
> - 因此：前端和后端的行为是一致的，本地校验只是为了减少无效请求、提升用户体验，不改变接口契约本身。

### 2.16 删除工作流批次（DELETE /api/workflows/{id}）

- 方法：`DELETE`  
- 路径：`/api/workflows/{id}`  
- 功能：根据 ID 删除一个工作流批次。

说明：

- 当前对工作流的状态不做限制：`draft` / `pending_ad` / `ready` / `in_use` / `archived` 等都可以删除；  
- 删除时依赖数据库的 ON DELETE CASCADE 规则，会自动删除：  
  - 该工作流下的所有 `landing_page` 记录；  
  - `workflow_ad_map` 中与该工作流相关的广告图关联记录；  
- 不会删除或影响以下数据：  
  - 视频素材表 `video`；  
  - 模板表 `template`；  
  - 广告图素材表 `ad_image_library`；  
  - 其他工作流及其落地页记录。

成功响应示例：

```json
{
  "code": 0,
  "message": "ok",
  "data": {}
}
```

失败示例（工作流不存在时）：

```json
{
  "code": 1,
  "message": "workflow 123 not found",
  "data": {}
}

### 2.17 预览落地页（POST /api/workflows/preview）

- 方法：`POST`  
- 路径：`/api/workflows/preview`  
- 功能：根据选中的视频和单个模板，生成一个用于预览的静态 HTML 文件，并返回预览 URL；不会创建 `landing_page` 记录，也不会修改 `workflow` 状态。

请求体（JSON）：

```json
{
  "video_ids": [101, 102, 103],
  "template_id": 1
}
```

字段说明：

- `video_ids`：选中的视频 ID 列表；长度必须不少于模板的 `max_videos`；  
- `template_id`：要预览的模板 ID（`template.id`）。

成功响应示例：

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "preview_url": "/generated/preview/1_abc123.html"
  }
}
```

说明：

- `preview_url` 为后端生成的静态 HTML 访问路径，通常用于前端在弹窗中通过 `<iframe>` 预览完整页面；  
- 预览文件位于 `backend/generated/preview/` 目录下，可视为临时文件；  
- 若模板不存在或 `video_ids` 数量不足，将返回 `code = 1` 和错误 `message`，前端应使用弹窗提示用户。
```
