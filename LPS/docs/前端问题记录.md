# 前端问题记录与修复说明

本文件用于记录前端在实际开发中遇到的典型问题及修复方式，方便后续会话快速对齐上下文。  
（补充说明：此文档不会替代原有的《开发日志》《新会话指引》，而是作为它们的补充。）

---

## 1. 落地页生成页本地校验弹窗不生效（已修复）

### 1.1 问题现象

- 页面：`/workflows/:workflowId/generate`（`WorkflowGeneratePage.tsx`）  
- 场景：  
  - 模板 `max_videos = 3`；  
  - 用户只勾选 2 个视频，然后点击“生成落地页”。  
- 预期：  
  - 前端在 `validateSelection()` 中拦截；  
  - 使用 Modal 弹出“至少需要 3 个视频”的错误提示；  
  - 不调用后端 `POST /api/workflows/{id}/generate`。  
- 实际：  
  - 点击“生成落地页”按钮后，界面完全无变化；  
  - 看起来“没有任何提示”，浏览器控制台也无报错。  
  - 甚至连一个简单的 `Modal.info`“测试弹窗”也不会出现。

### 1.2 根因分析

1. 技术栈升级带来的兼容性问题
   - 前端依赖版本：
     - `react`: 19.x  
     - `antd`: 5.29.x  
   - 项目中仍使用 antd 的静态调用方式：`Modal.error / Modal.warning / Modal.info`。
   - antd v5 在 React 19 下更推荐通过 `<App />` 提供上下文，再使用 `App.useApp().modal` 来创建对话框：
     - 静态 `Modal.xxx` 在没有正确的 App / 主题上下文时，可能“静默失败”，即不渲染对话框也不抛错。

2. 模板 ID 匹配上的小坑
   - AntD `Table` 的 `rowSelection.selectedRowKeys` 在运行时可能是 `string[]`；  
   - 模板实体 `Template.id` 是 `number`；  
   - 原逻辑使用：`selectedTemplateIds.includes(t.id)` 进行匹配；  
   - 在 `selectedTemplateIds` 为 `string[]` 时会导致模板匹配失败，从而出现“选中模板列表为空”的情况。

综合结果就是：  
前端本地校验逻辑写在 `validateSelection()` 里，但弹窗既没有真正渲染出来，模板匹配还可能因为类型不一致而失败，因此对用户表现为“点击按钮没任何反馈”。

### 1.3 修复方案（已落地）

#### （1）在全局接入 AntD App 上下文

- 文件：`LPS_creativ/LPS/frontend/src/App.tsx`
- 关键修改：

```ts
import { ConfigProvider, App as AntdApp } from 'antd'

// ...

<QueryClientProvider client={queryClient}>
  <ConfigProvider
    locale={zhCN}
    theme={{ token: { colorPrimary: '#1677ff' } }}
  >
    <AntdApp>
      <BrowserRouter>
        {/* Routes */}
      </BrowserRouter>
    </AntdApp>
  </ConfigProvider>
  <ReactQueryDevtools initialIsOpen={false} />
</QueryClientProvider>
```

- 目的：  
  - 通过 `<AntdApp>` 提供 antd 的 App 上下文；  
  - 让页面组件可以使用 `App.useApp()` 获取 `modal` 实例。

#### （2）生成页改用 `modal` 实例而不是静态 `Modal.xxx`

- 文件：`LPS_creativ/LPS/frontend/src/pages/WorkflowGeneratePage.tsx`
- 关键修改：

```ts
import { Card, Typography, Table, Button, message, Space, Alert, App } from 'antd'

export const WorkflowGeneratePage: React.FC = () => {
  const { modal } = App.useApp()
  // ...
}
```

- 将所有静态调用替换为实例调用：

```ts
if (!canGenerate) {
  modal.warning({
    title: '无法生成落地页',
    content: '请至少选择 1 个视频和 1 个模板。',
  })
  return false
}

// 模板不存在
modal.error({
  title: '无法生成落地页',
  content: '选中的模板不存在，请刷新页面后重试。',
})

// 视频数量不足
modal.error({
  title: '无法生成落地页',
  content: `当前选中的模板中，最大需要 ${maxRequired} 个视频，你只选了 ${selectedVideoIds.length} 个，请多选一些视频后再生成。`,
})
```

- 同时保留了一个“测试弹窗”按钮，用于快速验证 Modal 是否正常工作：

```tsx
<Button
  style={{ marginLeft: 8 }}
  onClick={() => {
    modal.info({
      title: '测试弹窗',
      content: '这是一个测试用的 AntD Modal.info，如果你能看到这个弹窗，说明 Modal 正常工作。',
    })
  }}
>
  测试弹窗
</Button>
```

#### （3）统一模板 ID 类型，避免匹配失败

- 问题：`selectedTemplateIds` 可能是 `string[]`，而模板 `id` 是 `number`。  
- 修复代码片段：

```ts
const templates = templateData?.items ?? []
// AntD Table 的 selectedRowKeys 在运行时可能是 string[]，
// 这里统一转成数字集合，避免类型不一致导致匹配失败
const selectedIdSet = new Set(
  selectedTemplateIds.map((id) => Number(id)),
)
const selectedTemplates = templates.filter((t) =>
  selectedIdSet.has(Number(t.id)),
)
```

### 1.4 验证结果

- 在 Firefox 和 Chrome 中测试：
  - “测试弹窗”按钮可以正常弹出 AntD 对话框；  
  - 当 `max_videos = 3`、只选 2 个视频时，点击“生成落地页”会弹出正确的错误提示，不会发送后端请求。  
- 控制台可以看到调试日志：  
  - `[WorkflowGeneratePage] 点击生成按钮 ...`  
  - `[WorkflowGeneratePage] validateSelection ...`  
  - `[WorkflowGeneratePage] 匹配到的模板 ...`  
  - `[WorkflowGeneratePage] 数量对比 ...`

### 1.5 对后续开发的约定

- 新页面如需使用 AntD 弹窗：
  - 优先通过 `const { modal } = App.useApp()` 获取实例方法：`modal.info / modal.error / modal.warning`；  
  - 不再推荐直接使用静态 `Modal.xxx`。  
- 当涉及到 `Table.rowSelection.selectedRowKeys` 与业务实体 ID 匹配时：
  - 请注意运行时类型可能是 `string[]`；  
  - 建议统一转换为 `number` 或统一用字符串进行比较，避免本地校验 “看起来没走” 的错觉。

