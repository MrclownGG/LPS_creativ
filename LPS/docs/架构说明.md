# 架构说明（整理版）

本文档描述 LPS Creativ 项目的整体架构、技术栈和主要数据流。  
随着功能增加，会不断补充和细化，但这里始终是“实现层面”的总览。

---

## 1. 总体目标与系统边界

LPS Creativ 是一个「FB 广告落地页生成系统」：

- 从公司已有的视频素材系统获取热门视频（或由运营手动录入）；  
- 让美工选择视频与模板，自动生成落地页 HTML；  
- 支持将落地页与广告图打包下载，提供给投流同事使用。

系统边界：

- 只负责「生成与打包」，**不直接管理** 广告账户、广告组、投放计划等投流平台对象；  
- 不存储视频文件本身，只存储视频元数据（标题、封面 URL、外部 ID 等）；  
- 不负责投放平台上的素材匹配逻辑，只产出「落地页 + 素材 ZIP」。

---

## 2. 技术栈总览

### 2.1 后端

- 语言：Python 3.11（建议）  
- Web 框架：FastAPI  
- 数据库：PostgreSQL  
- ORM：SQLAlchemy 2.x  
- 迁移工具：Alembic  
- 配置管理：`.env` + `python-dotenv` + Pydantic `BaseModel`  
- HTTP 客户端：`httpx`（用于调用外部热门视频排行榜接口）  
- 静态文件：
  - 模板静态资源：`/templates` → `LPS_creativ/LPS/templates`
  - 生成内容目录：`/generated` → `LPS_creativ/LPS/backend/generated`，包含：
    - 工作流生成的落地页 HTML：`/generated/{workflow_id}/{landing_page_id}.html`
    - 落地页 / 模板预览 HTML：`/generated/preview/...`、`/generated/template_preview/...`
    - 美工上传的视频封面图：`/generated/video_posters/{video_id}/poster.{ext}`

### 2.2 前端

- 构建工具：Vite（React + TypeScript 模板）  
- 框架：React 18/19  
- 语言：TypeScript  
- UI 组件库：Ant Design 5.x  
- 路由：React Router  
- 数据获取与缓存：Axios + @tanstack/react-query  
- 状态与交互：
  - 全局采用 React Query 管理接口调用与缓存，Mutation 负责触发写操作；
  - 重要交互统一使用 AntD `App.useApp().modal`（而非静态 `Modal.xxx`），避免 React 19 下的上下文问题。

### 2.3 通用约定

- 所有后端业务接口返回统一结构：

  ```json
  {
    "code": 0,
    "message": "ok",
    "data": { /* 具体数据 */ }
  }
  ```

  - `code = 0` 表示成功；非 0 表示业务或系统错误；  
  - `message` 为人类可读文字（中英文均可）；  
  - `data` 为具体数据或额外错误信息。

- 典型元信息：
  - `external_id`：外部系统的唯一 ID（用于去重和对齐）；  
  - `status`：内部状态枚举（例如 `draft` / `pending_ad` / `ready` / `archived` 等）。

---

## 3. 系统模块（逻辑层面）

从业务角度，系统拆分为三大模块：

1. **视频与模板管理**
   - 视频素材库：手动录入 / 从外部系统同步热门视频 / 查询与筛选；  
   - 落地页模板库：注册模板、维护元数据（HTML 路径、静态资源路径、容量等）。
2. **落地页工作流**
   - 工作流批次列表：批次状态管理；  
   - 生成流程：选择视频 + 选择模板 → 生成多个落地页 HTML；  
   - 预览功能：在生成前预览落地页效果；  
   - 广告图上传（蓝图中已规划，正式实现尚未开始）。
3. **投流计划与下载中心（蓝图阶段）**
   - 选择 `ready` 状态的工作流批次，配置渠道/地区，导出用于投放的素材包；  
   - 当前数据库结构已预留 `campaign` / `campaign_workflow_map`，接口尚未落地。

---

## 4. 后端架构（当前实现）

后端采用经典的分层结构：Router + ORM + 静态文件。

### 4.1 层次划分

- **API 层（Router / Controller）**
  - 定义 URL 路由与 HTTP 方法；  
  - 只做参数解析与结果封装，不直接操作底层数据库细节；  
  - 统一返回 `{code, message, data}`。

- **（潜在）服务层（Service）**
  - 当前逻辑较简单，多数代码仍在 Router 中；  
  - 后续复杂度上升时，可以抽出 Service 承载组合逻辑与外部 API 调用。

- **仓储层 / 数据访问层（Repository / DAO）**
  - 目前直接使用 SQLAlchemy 的 Session + ORM 模型；  
  - 每个实体（`video` / `template` / `workflow` / `landing_page` / …）都有对应的 CRUD 逻辑。

### 4.2 核心组件

- `backend/app/main.py`
  - 创建 FastAPI 应用；  
  - 注册基础路由：
    - `GET /health`：服务健康检查；  
    - `GET /db-check`：数据库连通性检查。  
  - 注册业务 Router：`/api/videos`、`/api/templates`、`/api/workflows`；  
  - 配置 CORS（允许本地前端 dev server 访问）；  
  - 挂载静态目录：
    - `/generated` → `backend/generated`（生成的落地页 HTML + 封面图等）；  
    - `/templates` → `LPS/templates`（模板 CSS/JS/图片等静态资源）。

- `backend/app/core/config.py`
  - 使用 `python-dotenv` 读取 `.env`；  
  - 使用 Pydantic `Settings` 管理配置：
    - `environment` / `api_version` / `database_url`；  
    - `EXTERNAL_VIDEO_API_URL` / `EXTERNAL_VIDEO_API_TOKEN`（外部热门视频接口配置，可选）。  
  - `get_settings()` 使用 LRU 缓存，避免重复解析。

- `backend/app/db/session.py`
  - 创建 SQLAlchemy 引擎与 Session 工厂；  
  - 提供 `get_db()` 依赖注入；  
  - 提供 `get_db_health()` 用于 `/db-check` 做数据库连通性测试。

---

## 5. 前端架构（当前实现）

### 5.1 入口与全局配置

- `frontend/src/main.tsx`
  - 挂载 React 根组件；  
  - 引入全局样式。

- `frontend/src/App.tsx`
  - `QueryClientProvider`：React Query 全局 Client；  
  - `ConfigProvider`：AntD 主题与中文 locale；  
  - `AntdApp`：为全局提供 `App.useApp()` 上下文（用于统一 modal/message 用法）；  
  - `BrowserRouter`：前端路由。

### 5.2 页面与路由

- 主布局：`frontend/src/layouts/MainLayout.tsx`（左侧菜单 + 顶栏 + 内容区）。  
- 主要页面：
  - `VideoListPage`（`/videos`）：影片素材库；  
  - `TemplateListPage`（`/templates`）：模板管理；  
  - `WorkflowListPage` / `WorkflowDetailPage` / `WorkflowGeneratePage`（`/workflows/...`）：落地页工作流；  
  - `CampaignListPage`（占位页面，投流计划模块尚未实现）。

### 5.3 前端数据层

- `frontend/src/api/client.ts`
  - 统一创建 Axios 实例，`baseURL = http://127.0.0.1:8000/api`；  
  - 所有 API 调用通过该实例发送。

- `frontend/src/api/videos.ts`
  - 定义视频实体 `Video`、列表响应 `VideoListData`、同步结果 `VideoSyncData` 等类型；  
  - 提供：
    - `getVideos` / `useVideos`：分页查询视频列表；  
    - `createVideo` / `updateVideo` / `deleteVideo`：手动导入 / 编辑 / 删除视频；  
    - `syncVideos`：调用 `POST /api/videos/sync`，从 STCine 排行接口同步热门视频；  
    - `uploadVideoPoster`：调用 `POST /api/videos/{id}/poster` 上传本地封面图并更新 `poster_url`。

- `frontend/src/api/templates.ts`
  - 管理模板实体 `Template` 与 CRUD 接口。

- `frontend/src/api/workflows.ts`
  - 管理工作流实体 `Workflow` 与落地页生成 / 预览接口。

---

## 6. 核心业务流程示例

### 6.1 视频列表与素材管理

1. **手动导入视频**  
   - 调用 `POST /api/videos`，填入 `title` / `poster_url` / `category` / `view_count` 等；  
   - 后端将记录写入 `video` 表，`status` 初始为 `active`。  
2. **外部同步热门视频（STCine）**  
   - 前端在「影片素材库」页面点击「从 API 导入」按钮；  
   - 弹出对话框选择数据来源（当前为 STCine）、日期范围和同步条数 `limit`；  
   - 调用 `POST /api/videos/sync?start_date=...&end_date=...&limit=...`；  
   - 后端通过 `httpx` 调用 STCine 排行接口，并按 external_id upsert 至 `video` 表；  
   - 同步成功后返回 `imported_count` / `updated_count`，前端提示“新建 X 条，更新 Y 条”。  
3. **修改视频封面图**  
   - 在列表中点击某条视频的「修改封面」按钮；  
   - 前端打开本地文件选择框，选择一张图片；  
   - 调用 `POST /api/videos/{id}/poster` 上传图片；  
   - 后端将文件保存至 `backend/generated/video_posters/{video_id}/poster.{ext}`，并更新 `poster_url`；  
   - 之后的 STCine 同步不会覆盖已有的 `poster_url`。

### 6.2 落地页生成流程

1. 在工作流列表页点击「生成落地页」，进入 `WorkflowGeneratePage`；  
2. Step 1：勾选视频素材；  
3. Step 2：勾选模板，前端会本地校验「已选视频数量 ≥ 所选模板中最大 `max_videos`」；  
4. 点击「生成落地页」：
   - 调用 `POST /api/workflows/{id}/generate`，请求体：
     ```json
     {
       "video_ids": [101, 102, 103],
       "template_ids": [1, 2]
     }
     ```  
   - 后端为每个模板插入一条 `landing_page` 记录；  
   - 读取模板 HTML，修正静态资源路径为 `/templates/...`，注入选中视频 ID JSON；  
   - 将 HTML 输出到 `backend/generated/{workflow_id}/{landing_page_id}.html`；  
   - 将 `generated_page_url` 设置为 `/generated/{workflow_id}/{landing_page_id}.html`；  
   - 将 `workflow.status` 从 `draft` 更新为 `pending_ad`。  
5. 工作流详情页展示所有落地页的 `generated_page_url`，可直接访问或进行后续打包。

### 6.3 落地页预览（手机视图）

1. 在 `WorkflowGeneratePage` 中勾选视频与单个模板，点击「预览」；  
2. 前端调用 `POST /api/workflows/preview`，请求体：
   ```json
   {
     "video_ids": [101, 102, 103],
     "template_id": 1
   }
   ```  
3. 后端复用生成逻辑，但不创建 `landing_page` 记录，也不修改 `workflow` 状态，仅生成：
   - 预览文件：`backend/generated/preview/{template_id}_{uuid}.html`；  
   - 返回 `preview_url = "/generated/preview/{filename}.html"`。  
4. 前端在弹出的 Modal 中通过 `<iframe>` 渲染预览，并将 Modal 设计为接近手机尺寸的视图（约 430×800），便于桌面环境下模拟移动端展示效果。

---

## 7. 外部视频系统同步（STCine 排行版）

为接入公司已有 App 的热门视频接口，后端提供了 `POST /api/videos/sync`：

- 配置：

  ```env
  EXTERNAL_VIDEO_API_URL=https://admin.good-videos.org/adminapi/log.playInfo/playRankAllDataLists
  EXTERNAL_VIDEO_API_TOKEN=
  ```

- 调用方式：
  - 前端或定时任务可调用 `POST /api/videos/sync?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD&limit=50`；  
  - 若未传日期，后端按“昨天”自动计算；  
  - 若只传一个日期，则视为单日范围。

- 字段映射策略：
  - `external_id = "STCine:{movie_id}"`  
  - `title = ch_name`（中文名）  
  - `view_count`：直接使用排行榜的播放量  
  - `category = "stcine_hot"`（默认分类，后续可替换为真实分类）  
  - `poster_url`：新插入时为空字符串 `""`，后续可由人工上传封面补全  
  - `metadata_`：记录 `source` / `movie_id` / `name_pt` / `langue` 等扩展信息

- Upsert 行为：
  - 已存在同一 `external_id` 的视频：更新 `title` / `view_count` / `category` / `metadata_`，**不覆盖** 已维护好的 `poster_url`；  
  - 不存在时插入新视频记录。

---

## 8. 模板与落地页渲染

### 8.1 模板目录

- 根目录：`LPS_creativ/LPS/templates`  
- 示例模板：`LPS_creativ/LPS/templates/home/`：
  - `index.html`  
  - `css/`、`js/`、`images/` 等静态资源子目录

### 8.2 模板元数据（template 表）

- 通过 `POST /api/templates` 注册模板时，存储：
  - `html_file_path`：HTML 模板文件路径（可填写相对仓库根的路径，如 `LPS/templates/home/index.html`）；  
  - `static_assets_path`：静态资源路径，用于计算 `/templates/...` 前缀（建议填写相对于 `LPS/templates` 的路径，如 `home`）；  
  - `max_videos`：该模板允许放置的视频数量上限；  
  - `status`：模板状态（`active` / `inactive`）。

### 8.3 路径修正与预览

- 渲染 / 预览时，后端会：
  - 根据 `html_file_path` 多策略尝试找到真实文件位置（兼容 `LPS/templates/home/index.html` 等多种写法）；  
  - 根据 `static_assets_path` 计算静态前缀 `static_prefix`，通常为 `/templates/home`；  
  - 将 HTML 内部的相对静态路径：

    ```html
    href="./css/..."
    src="./images/..."
    ```

    替换为以 `/templates/...` 开头的绝对路径，例如：

    ```html
    href="/templates/home/css/..."
    src="/templates/home/images/..."
    ```

  - 这样在浏览器访问 `/generated/...` 时，所有 CSS/图片/JS 都能通过 `/templates` 静态目录正常加载。

---

## 9. 规范与约定（与新会话指引配合使用）

> 这一节只做简要提醒，具体协作习惯详见 `LPS/docs/新会话指引.md`。

- **文档驱动**：涉及数据结构、状态流转、接口形态的变更，必须同步更新：
  - `LPS_creativ/Test/数据库蓝图文档.md`  
  - `LPS_creativ/LPS/docs/数据库设计说明.md`  
  - `LPS_creativ/LPS/docs/接口约定.md`  
  - `LPS_creativ/LPS/docs/开发日志.md`

- **状态枚举**：数据库中的状态字段统一使用英文枚举（例如 `draft` / `pending_ad` / `ready` / `archived`），前端展示时再映射成中文。  

- **错误处理**：
  - 后端统一以 `{code, message, data}` 返回错误信息；  
  - 前端对严重影响操作的错误，优先使用 `Modal.error` 或明显的页面区域展示，而不是轻提示。

- **协作习惯**（本项目特定约定）：
  - 在实现新功能前，先向用户说明设计思路（改哪些文件、接口大致长什么样），等待明确确认后再写代码；  
  - 功能实现后，先解释改动内容和影响，再询问用户“是否需要把这次改动同步到文档（开发日志 / 接口约定 / 数据库设计说明 / 蓝图）”；  
  - 在用户明确同意之前，不自行修改上述文档；  
  - 遇到不确定的业务规则或外部接口字段时，优先提问而不是自行假设。  

