# 新会话指引（给下一位 AI 工程师看的说明）

这份文档是专门写给“新开会话的 AI 助手”的，请在开始写任何代码之前完整阅读，并遵守其中约定。

## 一、请先阅读这些文档

进入项目后，请优先阅读：

1. 需求与蓝图
   - `LPS_creativ/需求文档.md`：整体业务需求说明。
   - `LPS_creativ/Test/数据库蓝图文档.md`：LPS_Creativ V1.4 系统蓝图，实体与流程的“真理源”。

2. 实现层面总览
   - `LPS_creativ/LPS/README.md`：正式实现的结构说明（前后端目录、技术栈）。
   - `LPS_creativ/LPS/docs/架构说明.md`：整体分层（Controller/Service/Repository 等）与数据流。
   - `LPS_creativ/LPS/docs/数据库设计说明.md`：当前 PostgreSQL 表结构与实体关系（与蓝图对齐）。

3. 接口与当前实现进度
   - `LPS_creativ/LPS/docs/接口约定.md`：
     - 定义了统一的 `{code, message, data}` 返回格式。
     - 列出视频、模板、工作流等模块已实现接口（路径、请求参数、响应结构）。
   - `LPS_creativ/LPS/docs/开发日志.md`：
     - 按时间记录了已实现的功能模块；
     - 特别包含“当前已知问题 / 待解决事项”（例如落地页生成页的本地校验弹窗问题）。

> 在没有对这些文档建立清晰认识之前，请不要随意新增接口或改动数据结构。

## 二、当前已有的功能模块（简要）

1. 视频素材库（Video 模块）
   - 后端：
     - `GET /api/videos`：查询视频列表。
     - `POST /api/videos`：手动导入视频。
     - `PUT /api/videos/{id}`：编辑视频信息。
     - `DELETE /api/videos/{id}`：删除视频（硬删）。
   - 前端：
     - 页面：`VideoListPage`（`/videos`）
     - 功能：增 / 查 / 改 / 删 + 搜索。

2. 模板管理（Template 模块）
   - 后端：
     - `GET /api/templates`：模板列表。
     - `POST /api/templates`：注册新模板。
     - `PUT /api/templates/{id}`：编辑模板信息。
     - `DELETE /api/templates/{id}`：删除模板（硬删）。
   - 模板文件：
     - 标准模板目录：`LPS_creativ/LPS/templates/home/`（已有一套静态首页模板）。
   - 前端：
     - 页面：`TemplateListPage`（`/templates`）
     - 功能：模板元数据的增 / 查 / 改 / 删。

3. 落地页生成（工作流 Workflow + LandingPage 模块）
   - 后端：
     - `GET /api/workflows`：工作流列表。
     - `POST /api/workflows`：创建工作流批次（状态初始为 `draft`）。
     - `GET /api/workflows/{id}`：工作流详情 + 落地页列表。
     - `POST /api/workflows/{id}/generate`：
       - 根据 `video_ids[]` + `template_ids[]` 生成 `landing_page` 记录；
       - 校验视频数量与模板 `max_videos` 的关系；
       - 更新状态到 `pending_ad`。
     - `POST /api/workflows/{id}/archive`：仅允许对 `ready` 状态批次归档为 `archived`。
   - 前端：
     - 列表页：`WorkflowListPage`（`/workflows`）
       - 显示批次列表，支持按状态筛选；
       - 中文状态文案：草稿 / 生成中 / 广告待上传 / 准备完成（待投流） / 已投流 / 已归档。
       - 操作：新建批次 / 查看详情 / 生成落地页。
     - 详情页：`WorkflowDetailPage`（`/workflows/:workflowId`）
       - 显示当前批次基本信息与落地页列表。
     - 生成页：`WorkflowGeneratePage`（`/workflows/:workflowId/generate`）
       - Step1：多选视频；
       - Step2：多选模板；
       - 点击“生成落地页”调用后端生成接口。

> 投放计划（campaign）模块和广告图关联模块尚未实现，只在蓝图与数据库结构中定义。

## 三、当前已知问题（请优先关注和验证）

1. 落地页生成页的本地校验弹窗
   - 场景：
     - 模板 `max_videos = 3`，用户只选择 2 个视频后点击“生成落地页”。
   - 预期：
     - 前端应在 `validateSelection()` 中拦截：
       - 调用 `Modal.error({...})` 显示“最大需要 3 个视频，你只选了 2 个”的弹窗；
       - 不调用后端 `POST /api/workflows/{id}/generate`。
   - 用户反馈：
     - 本地使用时，点击按钮后界面完全无变化，没有任何弹窗；
     - 浏览器控制台无报错。
   - 当前代码：
     - `WorkflowGeneratePage.tsx` 中的 `validateSelection()` 已包含调用 `Modal.error` 的逻辑。
   - 你的任务：
     - 请在接手后先复现该问题：
       - 确保前端 dev server 运行的是当前代码版本；
       - 在生成页中设置上面描述的选择情况（模板 max_videos > 已选视频数）；
       - 临时添加 `console.log` 或其他方式确认 `validateSelection` 是否被执行；
       - 检查 Ant Design `Modal` 是否正常渲染；
       - 如有必要，可重构校验逻辑，保证错误提示能被用户清晰看到（可以考虑统一用 Modal，或在页面中增加明显的错误区域）。

2. `generated_page_url` 仍为占位
   - 当前仅保存 `/generated/{workflow_id}/{template_id}.html` 形式的占位字符串；
   - 未实现实际 HTML 渲染与静态文件输出；
   - 后续需要设计模板渲染管道，并与 `home` 模板结合。

3. 未实现的业务动作
   - 工作流“归档”操作在前端列表尚未开放按钮（后端接口已存在）；
   - 广告图上传与关联（`ad_image_library` / `workflow_ad_map`）；
   - 投放计划模块（`campaign`），包括：
     - `GET/POST` 计划接口；
     - 选择 `ready` 状态的工作流形成下载包等。

## 四、接下来编程时必须遵守的约定

1. 不要绕过文档，所有关键决策必须同步到文档
   - 修改数据结构、状态流转、接口路径等“系统行为”时：
     - 必须同步更新：
       - `数据库蓝图文档.md`
       - `LPS/docs/数据库设计说明.md`
       - `LPS/docs/接口约定.md`
       - `LPS/docs/开发日志.md`（记录变更和原因）
   - 不要只在聊天里“说了一版”，不落到文档上。

2. 需要多向用户确认的典型问题
   - 一旦涉及：
     - 状态枚举的变更（例如新增工作流状态）；
     - 界面文案（例如状态中文名称、菜单名称）；
     - 业务流程（例如谁有权限归档、是否允许重复生成等）；
   - 请先向用户确认意图，而不是自行拍板。

3. 遇到歧义或 Bug，要显式记录
   - 像“落地页生成页校验不生效”这种问题，一旦发现：
     - 调查到一定程度后，如果当场无法彻底解决：
       - 请在 `LPS/docs/开发日志.md` 的“当前已知问题”部分补充说明；
       - 简要写明：
         - 场景；
         - 预期 vs 实际；
         - 已尝试的方向；
         - 建议后续如何继续排查。

4. 保持前后端返回格式和错误处理统一
   - 所有接口返回格式保持 `{ code, message, data }`：
     - `code = 0` 表示成功；
     - 非 0 表示错误，`message` 中写明原因；
   - 前端：
     - 成功时可以用 `message.success`；
     - 错误（尤其是影响业务操作的错误）优先使用 `Modal.error` 或在页面位置明显展示，而不是只在右上角一闪而过。

5. 不要隐藏“内部状态代码”
   - 数据库中的状态值继续使用英文枚举（draft / pending_ad / ready / archived 等）；
   - 前端展示时统一转换成中文文案，保持用户体验统一；
   - 如需新增状态，请在蓝图和接口文档中统一添加说明。

## 五、优先级建议（供接手时参考）

如果你是新会话接手，推荐的优先顺序：

1. 先复现并修复“生成落地页数量不足无弹窗”的问题（保证基本使用体验正常）。  
2. 设计并实现最小可用的模板渲染方案（基于 `home` 模板生成实际 HTML 文件）。  
3. 为工作流列表页增加“归档”按钮（仅对 `ready` 状态开放，调用 `POST /api/workflows/{id}/archive`）。  
4. 设计并实现广告图上传与关联功能（与 `ad_image_library` / `workflow_ad_map` 对应）。  
5. 开始实现投放计划模块（`campaign`），按蓝图的流程支持打包下载。

在每一步中，请记得：

- 先查蓝图 → 再看实现 → 再询问用户 → 最后写代码；
- 做完之后同步更新相关的 Markdown 文档。

