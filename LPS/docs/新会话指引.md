# 新会话指引（写给下一位 AI 工程师）

这份文档是专门写给“新开会话”的 AI 助手的。  
请在开始写任何代码之前完整阅读，并严格遵守其中约定。

---

## 一、进入项目前必须先看的文档

进入项目后，务必先把下面几份文档看完、看懂，再动代码：

1. **需求与蓝图（业务真理源）**
   - `LPS_creativ/需求文档.md`：整体业务需求说明。
   - `LPS_creativ/Test/数据库蓝图文档.md`：LPS_Creativ V1.4 系统蓝图（实体、流程、状态流转）。

2. **实现层面总览**
   - `LPS_creativ/LPS/README.md`：前后端目录结构、启动方式等。
   - `LPS_creativ/LPS/docs/架构说明.md`：整体架构、分层说明、静态目录挂载、模板渲染与预览流程。
   - `LPS_creativ/LPS/docs/数据库设计说明.md`：当前 PostgreSQL 表结构与实体关系（与蓝图对齐），含 `generated_page_url`、`poster_url` 等字段的实际含义。

3. **接口与当前实现进度**
   - `LPS_creativ/LPS/docs/接口约定.md`：
     - 统一 `{code, message, data}` 返回格式约定。
     - 已实现接口的路径 / 请求参数 / 响应结构。
     - 特别包括：
       - `GET /api/videos`：视频列表查询，返回 `view_count` 和 `updated_at` 等字段。
       - `POST /api/videos/sync`：从外部视频系统同步热门视频（当前已对接 STCine 排行接口）。
       - `POST /api/videos/{id}/poster`：上传视频封面，本地存储到 `/generated/video_posters/{id}/poster.{ext}`。
       - `POST /api/workflows/preview`：落地页预览。
       - `DELETE /api/workflows/{id}`：删除工作流批次。
   - `LPS_creativ/LPS/docs/开发日志.md`：
     - 按时间记录每次会话完成的功能与改动范围。
     - 包含“当前已知问题 / 待解决事项”以及最近加入的：
       - STCine 排行同步逻辑与导入按钮。
       - 视频列表“获取时间”列与“观看量 ↑↓ 排序”。
       - 视频封面本地上传与 `/generated/video_posters/...` 存储。
       - 模板渲染静态 HTML + 落地页预览能力。
   - `LPS_creativ/LPS/docs/前端问题记录.md`：
     - 记录前端踩过的坑（如 AntD `Modal` 在 React 19 下的使用方式）。

> 在没有对这些文档建立清晰认识之前，请不要随意新增接口或改动数据结构。

---

## 二、当前已有的功能模块（简要回顾）

### 2.1 视频素材库（Video 模块）

- 后端  
  - `GET /api/videos`  
    - 按分类 + 分页查询视频列表。  
    - 返回字段示例：`{id, title, poster_url, category, view_count, updated_at}`。  
  - `POST /api/videos`  
    - 手动导入单条视频素材（`external_id` 可选，用于对齐外部系统）。  
  - `PUT /api/videos/{id}`  
    - 编辑视频展示信息（标题 / 分类 / 封面 URL / 观看量）。  
  - `DELETE /api/videos/{id}`  
    - 删除视频（当前为硬删除：直接从 `video` 表删记录）。  
  - `POST /api/videos/{id}/poster`  
    - 上传本地图片作为封面，更新对应视频的 `poster_url`。  
    - 文件写入：`backend/generated/video_posters/{id}/poster.{ext}`。  
    - 外部同步接口不会覆盖手动上传的封面。  
  - `POST /api/videos/sync`  
    - 从外部视频系统同步热门视频（当前已对接 STCine 排行接口）。  
    - 主要 query：`start_date`, `end_date`, `limit`。  
    - 字段映射（简要）：  
      - `external_id = "STCine:{movie_id}"`。  
      - `title = ch_name | name | "未命名"`。  
      - `view_count`：排行榜播放量。  
      - `category = "stcine_hot"`（当前为默认分类）。  
      - `poster_url`：新插入时为空字符串 `""`，更新已有记录时不覆盖（保留人工封面）。  
      - `metadata_`：写入 `source / movie_id / name_pt / langue`。  
    - Upsert：  
      - 找到同一 `external_id`：更新上述字段（除 `poster_url`），计入 `updated_count`。  
      - 未找到：插入新 `video`，计入 `imported_count`。

- 前端（`VideoListPage`，路径 `/videos`）  
  - 基础：增 / 删 / 改 / 查 + 搜索（按标题或分类过滤）。  
  - 顶部按钮：  
    - 「手动导入」：打开表单，新建单条视频记录。  
    - 「从 API 导入」：弹出配置框，选择数据来源（当前为 STCine）、日期范围与同步条数，调用 `POST /api/videos/sync`。  
  - 表格列：  
    - 基础信息：ID / 标题 / 分类 / 海报 URL / 观看量。  
    - 「获取时间」：使用后端返回的 `updated_at` 字段，格式化为 `YYYY-MM-DD HH:mm`，表示最后一次导入 / 更新时间。  
  - 排序与封面维护：  
    - 「观看量」列表头右侧有一个小的 “↑↓” 按钮，可在不排序 / 播放量高→低 / 播放量低→高 三种模式之间切换（仅前端排序）。  
    - 行内「修改封面」操作：选择本地图片后调用 `POST /api/videos/{id}/poster`，成功后刷新列表；后续执行 STCine 同步时不会覆盖该手动封面。

### 2.2 模板管理（Template 模块）

- 后端  
  - `GET /api/templates`：模板列表。  
  - `POST /api/templates`：注册新模板（名称、HTML 路径、`max_videos`、`static_assets_path` 等）。  
  - `PUT /api/templates/{id}`：编辑模板信息。  
  - `DELETE /api/templates/{id}`：删除模板（硬删）。  
- 模板文件  
  - 标准模板目录：`LPS_creativ/LPS/templates/home/`。  
  - 模板静态资源（CSS / JS / 图片等）通过 `/templates` 静态目录暴露。  
- 前端（`TemplateListPage`，路径 `/templates`）  
  - 功能：模板元数据的增 / 删 / 改 / 查。  
  - 当前仅有一套示例落地页 HTML，模板预览功能本次会话只是讨论规划，尚未实现。

### 2.3 落地页生成（Workflow + LandingPage 模块）

- 后端  
  - `GET /api/workflows`：工作流列表。  
  - `POST /api/workflows`：创建工作流批次（初始状态 `draft`）。  
  - `GET /api/workflows/{id}`：工作流详情 + 落地页列表。  
  - `POST /api/workflows/{id}/generate`：  
    - 根据 `video_ids[]` + `template_ids[]` 生成 `landing_page` 记录。  
    - 校验视频数量与模板 `max_videos` 的关系。  
    - 渲染模板 HTML，到：`backend/generated/{workflow_id}/{landing_page_id}.html`。  
    - 更新 `generated_page_url = "/generated/{workflow_id}/{landing_page_id}.html"`。  
    - 将 `workflow.status` 从 `draft` 更新为 `pending_ad`。  
  - `POST /api/workflows/{id}/archive`：仅允许 `status = ready` 的工作流归档为 `archived`。  
  - `DELETE /api/workflows/{id}`：删除工作流批次（任意状态都允许，按蓝图级联删除其落地页和关联记录）。  
  - `POST /api/workflows/preview`：  
    - 根据 `video_ids[]` + `template_id` 生成一个预览用 HTML 文件。  
    - 输出到 `backend/generated/preview/{template_id}_{uuid}.html`，返回 `preview_url`。  
    - 不创建 `landing_page` 记录，不修改 `workflow` 状态。

- 前端  
  - 列表页：`WorkflowListPage`（`/workflows`）  
    - 显示批次列表，支持按状态筛选。  
    - 状态文案：草稿 / 生成中 / 广告待上传 / 准备完成 / 已投放 / 已归档。  
    - 操作：新建批次 / 查看详情 / 进入“生成落地页” / 删除批次等。  
  - 详情页：`WorkflowDetailPage`（`/workflows/:workflowId`）  
    - 展示当前批次基础信息与落地页列表（含 `generated_page_url`）。  
  - 生成页：`WorkflowGeneratePage`（`/workflows/:workflowId/generate`）  
    - Step1：多选视频。  
    - Step2：多选模板。  
    - “生成落地页”：本地校验通过后调用后端生成接口。  
    - “预览”：当前支持对单个模板进行预览，在 Modal 中通过 `<iframe>` 打开 `preview_url`，Modal 将逐步优化为接近手机比例（设计目标约 430×800）。

> 投放计划（campaign）模块和广告图素材模块尚未实现，只在蓝图与数据库结构中预留表结构。

---

## 三、当前已知问题与未完成事项（简要）

详细内容请看 `LPS_creativ/LPS/docs/开发日志.md` 的“当前已知问题 / 待解决事项”，这里只列出关键点：

1. **模板占位符与视频内容填充尚未实现**  
   - 当前模板渲染只做了静态 HTML 读取、静态资源路径修正，以及将 `selected_video_ids` 注入到 `<script id="lps-selected-videos">` 中。  
   - 还没有定义模板占位符（例如 `{{VIDEO_1_TITLE}}`、`{{VIDEO_1_POSTER_URL}}`）并根据 `selected_video_ids` 去替换内容。  
   - 后续需要设计占位符规则 + 字段映射逻辑，并在渲染函数中落地。

2. **STCine 同步只有“手动触发”，尚无自动化调度**  
   - `POST /api/videos/sync` 已经可以根据日期范围 + `limit` 从 STCine 接口拉取排行榜并入库。  
   - 目前需要运营手动在前端选择日期并点击“从 API 导入”。  
   - 尚未实现自动化任务（例如：每天定时拉取前一天的榜单），后续可以在后端或运维层增加调度脚本。

3. **模板管理的“模板预览”功能尚未实现**  
   - 当前只有 Workflow 里的落地页预览。  
   - 模板管理页暂时只能编辑元数据，无法直接预览模板框架。  
   - 本次会话已经讨论：希望在模板管理中增加“预览”按钮，并且以接近手机比例（约 430×800）展示模板整体框架。

4. **广告图模块与投放计划模块未落地**  
   - 蓝图和数据库中已经定义：`ad_image_library` / `workflow_ad_map` / `campaign` / `campaign_workflow_map` 等表。  
   - 尚未有对应的后端接口与前端界面。  

---

## 四、编程与协作约定（尤其是与用户互动的习惯）

这一节非常重要，直接影响后续会话的体验与项目一致性。

### 4.1 文档驱动开发（Doc-Driven）

涉及以下内容的改动，都被视为“系统级行为”：

- 数据结构：数据库表结构、字段含义、状态枚举。  
- 状态流转：例如 workflow 在哪些值之间转移。  
- 接口形态：路径、请求体、响应结构、错误码。  
- 关键业务流程：生成逻辑、预览逻辑、同步逻辑。

一旦有这类改动，**必须**在用户确认后同步更新：

- `LPS_creativ/Test/数据库蓝图文档.md`  
- `LPS_creativ/LPS/docs/数据库设计说明.md`  
- `LPS_creativ/LPS/docs/接口约定.md`  
- `LPS_creativ/LPS/docs/开发日志.md`

不要只在聊天里“说了一版”，不落到文档上。

### 4.2 与用户的沟通习惯（本次会话总结）

结合当前用户的偏好，后续会话请遵守以下协作流程：

1. **在实现功能前先说明思路**  
   - 当你准备新增一个功能或接口（例如“增加预览按钮”“增加外部同步接口”“调整预览尺寸”）时：  
     - 先用简短的文字说明设计思路（几行文字即可）；  
     - 明确会改动哪些文件、哪些接口；  
     - 然后问一句类似：“按这个方案现在开始实现可以吗？”  
     - 只有在用户明确同意后，才开始具体代码实现。

2. **实现完成后，先解释改动，再问要不要写文档**  
   - 功能完成后，先回答：  
     - 改了哪些文件、主要逻辑是什么；  
     - 可能的边界条件和当前限制。  
   - 然后再问用户：  
     - “是否需要把这次改动同步到开发日志 / 接口约定 / 数据库设计说明 / 蓝图？”  
   - 在用户明确说“同步到文档”之后，再去修改相关 Markdown，并保持风格统一。

3. **不要擅自改变业务语义**  
   - 任何涉及：  
     - 状态枚举增删改；  
     - 接口路径变更；  
     - 业务流程步骤调整（例如跳过 `pending_ad`、改变生成时机）。  
   - 必须先征求用户意见，不要自己“拍板”。

4. **遇到不确定时，优先提问而不是猜测**  
   - 例如外部视频接口字段不明确、模板占位符规则不清晰、状态含义有歧义时：  
     - 优先向用户要“接口示例 / 期望行为”；  
     - 若用户暂时不在线，可以在代码中写 `TODO`，并在开发日志中注明假设和风险。

5. **保持代码与文档风格一致**  
   - 代码中尽量使用当前已采用的模式（例如 Axios + React Query 的封装方式）。  
   - 文档中的标题和段落格式，尽量沿用现有风格（中文说明 + 简短英文标识）。  
   - 不随意引入风格完全不同的新写法，除非用户明确表示可以。

6. **用户只负责指挥，不直接改代码**  
   - 默认由 AI 负责具体代码与配置文件（包含 `.env`）的修改和运行，用户主要给出需求和决策。  
   - 用户不会主动去写代码或改 `.env`，不要把实现工作“丢回去”给用户。  
   - 在实现前先讲清楚方案，在实现后主动汇报结果，并在合适的时机提醒是否需要同步文档。

---

## 五、建议的接手优先级（供下一次新会话参考）

在当前进度基础上，推荐的优先开发顺序（在每一步之前都要先和用户确认方案）：

1. **落地页模板占位符与视频内容填充**  
   - 在现有模板（如 `home`）上设计一套最小可用的占位符规则（标题 / 封面图等）。  
   - 在后端渲染函数中，根据 `selected_video_ids` 查询 `video` 表并替换占位符。  
   - 确保预览效果与最终生成的落地页一致。

2. **模板管理页的“模板预览”功能（手机视图）**  
   - 在 `TemplateListPage` 中为每个模板增加“预览”按钮。  
   - 后端提供相应预览接口或复用现有渲染逻辑，生成模板预览用 HTML。  
   - 前端使用 Modal + `<iframe>` 以接近手机比例（约 430×800）的方式展示模板框架。

3. **广告图上传与关联功能**  
   - 落地 `ad_image_library` / `workflow_ad_map` 相关接口：上传图片、查询素材、关联到工作流。  
   - 在工作流详情页中展示和管理已关联的广告图。

4. **投放计划模块（campaign）**  
   - 实现 `campaign` 相关接口（创建计划、关联 workflow、打包下载）。  
   - 结合蓝图中的流程，设计前端页面（创建计划 / 勾选 ready 状态批次 / 下载打包）。

5. **STCine 同步的自动化与多数据源扩展**  
   - 在后端或运维层增加调度任务，实现每天自动导入指定日期的排行榜。  
   - 预留多数据源支持：未来接入其他热门视频来源时，复用同一套同步框架。

在每一步中，请记得：

- 先查蓝图 → 再看现有实现 → 再询问用户 → 最后才写代码。  
- 做完之后，在用户确认的前提下同步更新相关 Markdown 文档。

